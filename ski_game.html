<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“ˆçˆ¾æ¿±æ”¯ç·šï½œæ»‘é›ªå¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #0a0c12; color: white; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; }
        .snow-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(to bottom, #d6e2f0, #e0f2f7), url('https://i.imgur.com/P5j1w1h.png'), url('https://i.imgur.com/O61WJ7b.png');
            background-repeat: no-repeat; background-size: 100% 100%, 150% auto, 120% auto; background-position: center bottom; z-index: -1;
        }
        #gameCanvas { background: none; display: block; margin: 0 auto; cursor: crosshair; } 
        .ui-panel { 
            position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: none; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); 
        }
        .btn-action { 
            pointer-events: auto; background: linear-gradient(145deg, #007bff, #0056b3); color: white; padding: 14px 40px; border-radius: 99px; font-weight: bold; font-size: 1.25rem; letter-spacing: 1px; transition: all 0.2s ease-in-out; box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4); border: none; cursor: pointer;
        }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 123, 255, 0.5); }
        .btn-action:active { transform: scale(0.95); box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }
        #charSelect { width: 90%; max-width: 580px; margin: 10px auto 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; overflow: visible; }
        .card-container { width: 22%; aspect-ratio: 152 / 260; cursor: pointer; position: relative; perspective: 1200px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-container.is-selected .card-inner { transform: rotateY(180deg); }
        .card-container.is-selected { filter: drop-shadow(0 0 15px #e5a400); transform: scale(1.15); z-index: 10; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; background: none !important; overflow: hidden; }
        .card-front { background: linear-gradient(135deg, #1e293b, #0f172a); }
        .card-back { background: linear-gradient(135deg, #007bff, #0056b3); transform: rotateY(180deg); }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 1; display: block; }
        .card-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.75); color: white; font-size: 11px; padding: 4px 0; backdrop-filter: blur(3px); font-weight: 600; }
        #liveScore { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: bold; color: #6edaff; text-shadow: 0 0 8px rgba(110, 218, 255, 0.5); }
        .score-panel { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); border: 1px solid rgba(50, 184, 236, 0.2); padding: 6px 16px; border-radius: 99px; z-index: 1000; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .score-panel::before { content: "åˆ†æ•¸"; font-size: 10px; font-weight: 900; color: rgba(255, 255, 255, 0.6); letter-spacing: 1px; }
        h1.title-bounce { font-weight: 900; font-style: italic; color: #93c5fd; text-shadow: 2px 2px 0px #1e3a8a, 4px 4px 15px rgba(0,0,0,0.5); }
        
        @keyframes medal-zoom {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        #medalIcon { animation: medal-zoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ffeb3b; }
            100% { transform: scale(1); }
        }
        .score-bounce { animation: score-pop 0.3s ease-out; }

        canvas { touch-action: none; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0); }
    </style>
</head>
<body>

    <div class="snow-bg"></div>
    <div id="uiStart" class="ui-panel pointer-events-auto">
        <h1 class="text-5xl font-black italic mb-3 text-blue-300 title-bounce">æ»‘é›ªæŒ‘æˆ°GOï¼ğŸ§Š</h1>
        <p class="text-gray-300 mb-10 text-sm tracking-widest uppercase">â„ï¸ Yabuli Special Edition â„ï¸</p>
        <div id="charSelect"></div>
        <button onclick="start()" class="btn-action text-xl px-12 py-4">é–‹å§‹æ»‘é›ª</button>
    </div>

    <div id="uiOver" class="ui-panel hidden pointer-events-auto text-center">
        <div id="medalIcon" class="text-8xl mb-4 drop-shadow-lg"></div>
        <div id="medalTitle" class="text-3xl font-bold mb-2 drop-shadow-md"></div>
        <h2 class="text-5xl font-black text-red-400 mb-2 italic">æ‘”å€’äº†ï¼</h2>
        <p class="text-2xl mb-8">æœ€çµ‚å¾—åˆ†: <span id="finalScore" class="text-white font-bold">0</span></p>
        <button onclick="location.reload()" class="btn-action bg-red-600">é‡æ–°æŒ‘æˆ°</button>
    </div>

    <div class="score-panel"><span id="liveScore">0</span></div>
    <canvas id="gameCanvas"></canvas>

<script>
    let items = [], particles = [], obstacles = [], snowballs = [];
    let powerUpTimer = 0, stormMode = false, stormTimer = 0, friction = 0.12; 
    let selectedIdx = 4, running = false, score = 0, frame = 0, speed = 7, px, py = 150, tx;
    let comboCount = 0, comboScale = 1, lives = 5, heartTimer = 0, invincibilityTimer = 0;
    const MAX_LIVES = 5;
    let highScore = localStorage.getItem('skiHighScore') || 0;

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const CHARS = [
        { name: "çˆ¸", file: "1", boardType: "double", size: 55, faceY: 0.562, faceScale: 0.5, faceX: -0.01 },
        { name: "åª½", file: "2", boardType: "double", size: 55, faceY: 0.549, faceScale: 0.5, faceX: 0.005 },
        { name: "å“¥", file: "3", boardType: "single", size: 55, faceY: 0.575, faceScale: 0.49, faceX: -0.01 },
        { name: "è¨€", file: "4", boardType: "double", size: 55, faceY: 0.62, faceScale: 0.5, faceX: 0.007 },
        { name: "å¦¹", file: "5", boardType: "double", size: 55, faceY: 0.525, faceScale: 0.5, faceX: 0.005 },
        { name: "å¼Ÿ", file: "6", boardType: "single", size: 55, faceY: 0.569, faceScale: 0.496, faceX: -0.04 },
        { name: "Vivi", file: "7", boardType: "single", size: 55, faceY: 0.6065, faceScale: 0.5, faceX: -0.005 }
    ];

    const FACES = ['n', 's', 'h', 'e', 'd', 'b']; 
    const OBSTACLE_FILES = ['1.webp', '2.webp', '3.webp'];
    const charImages = {}, obsImages = {};
    const OBSTACLE_CONFIG = { '1.webp': { w: 70, h: 60, r: 35 }, '2.webp': { w: 50, h: 50, r: 35 }, '3.webp': { w: 70, h: 90, r: 35 } };

    function preloadAssets() {
        CHARS.forEach(c => {
            const mainImg = new Image(); mainImg.src = `images/ski/${c.file}.webp`;
            charImages[c.file] = mainImg;
            FACES.forEach(f => {
                const img = new Image(); img.src = `images/ski/${c.file}_${f}.webp`;
                charImages[`${c.file}_${f}`] = img;
            });
        });
        OBSTACLE_FILES.forEach(file => {
            const img = new Image(); img.src = `images/obs/${file}`;
            obsImages[file] = img;
        });
    }
    preloadAssets();

    function updateScore(points) {
        const multiplier = 1 + Math.floor(comboCount / 10);
        score += (points * multiplier);
        if (points === 1) { comboCount++; comboScale = 1.3; }
        const liveScoreEl = document.getElementById('liveScore');
        if (liveScoreEl) liveScoreEl.textContent = score;
        const scoreEl = document.querySelector('.score-panel');
        if (scoreEl) { scoreEl.classList.remove('score-bounce'); void scoreEl.offsetWidth; scoreEl.classList.add('score-bounce'); }
    }

    function initCharSelect() {
        const menu = document.getElementById('charSelect');
        menu.innerHTML = CHARS.map((c, i) => `
            <div class="card-container ${i === selectedIdx ? 'is-selected' : ''}" onclick="selectChar(${i})" id="char-card-${i}">
                <div class="card-inner">
                    <div class="card-front"><img src="images/char/${c.file}.webp" class="card-img"><div class="card-label">${c.name}</div></div>
                    <div class="card-back"><img src="images/char/${c.file}_real.webp" class="card-img" onerror="this.src='https://placehold.co/152x260/0056b3/white?text=${c.name}Real'"><div class="card-label">READY!</div></div>
                </div>
            </div>
        `).join('');
    }

    window.selectChar = (i) => {
        document.querySelectorAll('.card-container').forEach(el => el.classList.remove('is-selected'));
        selectedIdx = i;
        document.getElementById(`char-card-${i}`).classList.add('is-selected');
    };

    function resize() {
        canvas.width = Math.min(window.innerWidth, 500); canvas.height = window.innerHeight;
        px = tx = canvas.width / 2;
    }

    function start() {
        resize(); 
        document.getElementById('uiStart').classList.add('hidden');
        document.getElementById('uiOver').classList.add('hidden');
        highScore = localStorage.getItem('skiHighScore') || 0;
        running = true; score = 0; lives = 5; comboCount = 0; speed = 7; 
        obstacles = []; items = []; particles = []; snowballs = [];
        px = tx = canvas.width / 2;
        loop();
    }

    const move = (e) => {
        if(!running) return;
        let clientX = (e.touches && e.touches.length > 0) ? e.touches[0].clientX : e.clientX;
        const r = canvas.getBoundingClientRect();
        tx = Math.max(40, Math.min(canvas.width-40, (clientX - r.left) * (canvas.width / r.width)));
    };
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', move, { passive: false });
    window.addEventListener('touchstart', move, { passive: false });

    function loop() {
        if(!running) return;
        frame++; 

        if (powerUpTimer > 0) { powerUpTimer--; friction = 0.15; }
        else if (stormMode) { speed += 0.03; friction = 0.06; }
        else { friction = 0.12; }
        
        px += (tx - px) * friction; 
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        stormTimer++;
        if (stormTimer % 1200 === 0) stormMode = true; 
        if (stormMode && stormTimer % 1200 === 300) stormMode = false; 

        // 1. é€Ÿåº¦ç·š
        ctx.save();
        ctx.strokeStyle = '#c5e2f7'; ctx.lineWidth = 2;
        for(let i=0; i<6; i++) {
            let ly = (frame * speed * 0.8 + i * 150) % (canvas.height + 150);
            ctx.beginPath(); ctx.moveTo(i * canvas.width / 5, ly - 50); ctx.lineTo(i * canvas.width / 5, ly + 50); ctx.stroke();
        }
        ctx.restore();

        // 2. é“å…·
        if(frame % 250 === 0) {
            const type = Math.random() > 0.7 ? 'â­' : 'â¤ï¸';
            items.push({ x: Math.random() * (canvas.width - 80) + 40, y: canvas.height + 100, type: type });
        }
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i]; item.y -= speed;
            ctx.font = '40px serif'; ctx.textAlign = 'center';
            ctx.fillText(item.type, item.x, item.y);
            if(Math.hypot(px - item.x, py - item.y) < 45) { 
                if (item.type === 'â¤ï¸') { if (lives < MAX_LIVES) lives++; updateScore(5); heartTimer = 40; }
                else if (item.type === 'â­') { powerUpTimer = 180; updateScore(20); }
                items.splice(i, 1); 
            } else if(item.y < -100) { items.splice(i, 1); }
        }

        // 3. éšœç¤™ç‰©
        if(frame % Math.max(15, 40 - Math.floor(speed * 0.7)) === 0) {
            const file = OBSTACLE_FILES[Math.floor(Math.random() * OBSTACLE_FILES.length)];
            obstacles.push({ x: Math.random() * (canvas.width - 80) + 40, y: canvas.height + 100, file: file });
        }
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i]; o.y -= speed;
            const config = OBSTACLE_CONFIG[o.file] || { w: 60, h: 60, r: 35 };
            const img = obsImages[o.file];
            ctx.save();
            if (powerUpTimer > 0 && Math.hypot(px - o.x, py - o.y) < config.r + 20) ctx.globalAlpha = 0.3;
            if (img && img.complete) ctx.drawImage(img, o.x - config.w / 2, o.y - config.h / 2, config.w, config.h);
            ctx.restore();
            if (powerUpTimer <= 0 && invincibilityTimer <= 0 && Math.hypot(px - o.x, py - o.y) < config.r) {
                lives--; comboCount = 0; obstacles.splice(i, 1); invincibilityTimer = 60;
                if (lives <= 0) triggerGameOver(); 
            } else if(o.y < -150) { obstacles.splice(i, 1); updateScore(1); if(score % 5 === 0) speed += 0.2; }
        }

// --- 4. é›ªçƒæç¤ºèˆ‡ç”Ÿæˆé‚è¼¯ ---
        if (score >= 300) {
            // æç¤ºæ–‡å­—ï¼šç¢ºä¿é€™æ®µåœ¨ loop è£¡æœƒè¢«åŸ·è¡Œåˆ°
            if (score < 315) {
                ctx.save(); 
                ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®åº§æ¨™ç³»ç¢ºä¿ç•«åœ¨è¢å¹•ä¸­å¤®
                ctx.fillStyle = (frame % 20 < 10) ? "#ffffff" : "#3b82f6";
                ctx.font = "bold 35px Inter"; 
                ctx.textAlign = "center"; 
                ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 10;
                ctx.fillText("âš ï¸ æ³¨æ„å·¨å¤§é›ªçƒ âš ï¸", canvas.width / 2, canvas.height / 2); 
                ctx.restore();
            }

            // æ¯ 350 å¹€ç”Ÿæˆä¸€é¡†æ–°é›ªçƒ
            if(frame % 350 === 0) {
                snowballs.push({ x: Math.random() * (canvas.width - 100) + 50, y: canvas.height + 100, radius: 15, growth: 0.15 });
            }
        }

        // ç§»å‹•èˆ‡ç¢°æ’åˆ¤å®š (æ”¾åœ¨ score >= 300 ä¹‹å¤–ï¼Œç¢ºä¿ç”¢ç”Ÿçš„é›ªçƒæœƒæŒçºŒç§»å‹•)
        for (let i = snowballs.length - 1; i >= 0; i--) {
            let b = snowballs[i];
            b.y -= speed * 0.7; b.radius += b.growth;
            
            ctx.save();
            let grad = ctx.createRadialGradient(b.x - b.radius/3, b.y - b.radius/3, b.radius/4, b.x, b.y, b.radius);
            grad.addColorStop(0, '#ffffff'); grad.addColorStop(1, '#d1e9ff');
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.arc(b.x, b.y, b.radius * 0.8, 0, Math.PI * 0.5); ctx.stroke();
            ctx.restore();

            if (powerUpTimer <= 0 && invincibilityTimer <= 0 && Math.hypot(px - b.x, py - b.y) < b.radius + 10) {
                lives--; comboCount = 0; snowballs.splice(i, 1); invincibilityTimer = 60;
                if (lives <= 0) triggerGameOver();
            } else if(b.y < -150) { 
                snowballs.splice(i, 1); updateScore(10); 
            }
        }

        // ç¹ªè£½èˆ‡ç§»å‹•é‚è¼¯ï¼šé€™æ®µå¿…é ˆæ”¾åœ¨ score >= 300 çš„å¤§æ‹¬è™Ÿã€Œå¤–é¢ã€ï¼Œ
        // é€™æ¨£ä¸€æ—¦é›ªçƒç”¢ç”Ÿäº†ï¼Œå³ä½¿åˆ†æ•¸ç¹¼çºŒå¢åŠ ï¼Œå®ƒå€‘ä¹ŸæœƒæŒçºŒç§»å‹•ã€‚
        for (let i = snowballs.length - 1; i >= 0; i--) {
            let b = snowballs[i];
            b.y -= speed * 0.7; // å‘ä¸Šç§»å‹•ï¼ˆç‡Ÿé€ å‘ä¸‹è¡çš„æ•ˆæœï¼‰
            b.radius += b.growth; // è¶Šæ»¾è¶Šå¤§
            
            ctx.save();
            let grad = ctx.createRadialGradient(b.x - b.radius/3, b.y - b.radius/3, b.radius/4, b.x, b.y, b.radius);
            grad.addColorStop(0, '#ffffff'); 
            grad.addColorStop(1, '#d1e9ff');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // é›ªçƒè¡¨é¢çš„æ—‹è½‰ç·šæ¢æ„Ÿ
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius * 0.8, 0, Math.PI * 0.5);
            ctx.stroke();
            ctx.restore();

            // ç¢°æ’åµæ¸¬
            if (powerUpTimer <= 0 && invincibilityTimer <= 0 && Math.hypot(px - b.x, py - b.y) < b.radius + 10) {
                lives--; 
                comboCount = 0; 
                snowballs.splice(i, 1); 
                invincibilityTimer = 60;
                if (lives <= 0) triggerGameOver();
            } else if(b.y < -150) { 
                // é›ªçƒé›¢é–‹ç•«é¢
                snowballs.splice(i, 1); 
                updateScore(10); 
            }
        }

        // 5. ç©å®¶æ¸²æŸ“
        updateParticlesLogic();
        ctx.save(); 
        if (invincibilityTimer > 0) { invincibilityTimer--; if (frame % 6 < 3) ctx.globalAlpha = 0.2; }
        if (stormMode) ctx.translate((Math.random()-0.5)*5, (Math.random()-0.5)*5);
        ctx.translate(px, py);
        let tilt = Math.max(-0.2, Math.min(0.2, (tx - px) * 0.05));
        let tipSwing = tilt * 30;
        drawParticlesRelative();
        
        // é›ªæ¿
        ctx.save(); ctx.strokeStyle = '#3D3333'; ctx.lineWidth = (CHARS[selectedIdx].boardType === 'double') ? 10 : 25; ctx.lineCap = 'round';
        if (CHARS[selectedIdx].boardType === 'double') {
            const gap = 10; ctx.beginPath(); ctx.moveTo(-gap, -25); ctx.lineTo(-gap + tipSwing, 25); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(gap, -25); ctx.lineTo(gap + tipSwing, 25); ctx.stroke();
        } else { ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(tipSwing, 24); ctx.stroke(); }
        ctx.restore();

        // è¡¨æƒ…åˆ¤å®š
        if (heartTimer > 0) heartTimer--;
        let faceSuffix = "n";
        if (!running || invincibilityTimer > 0) faceSuffix = "d"; 
        else if (powerUpTimer > 0) faceSuffix = "e"; 
        else if (heartTimer > 0) faceSuffix = "b"; 
        else if (stormMode) faceSuffix = "s"; 
        else if (score > 0 && score % 15 <= 3) faceSuffix = "h";

        const charData = CHARS[selectedIdx], charID = charData.file;
        const bodyImg = charImages[charID], faceImg = charImages[`${charID}_${faceSuffix}`];
        const drawW = charData.size || 70, drawH = (260 / 152) * drawW;

        ctx.save();
        let breath = Math.sin(frame * 0.15) * 2; ctx.translate(0, breath); ctx.rotate(tilt * 0.5); 
        if (bodyImg && bodyImg.complete) {
            if (heartTimer > 20) { 
                ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.translate(px, py); ctx.fillStyle = "#ff4d4d"; ctx.font = `bold ${Math.floor(drawW * 0.4)}px Inter`;
                ctx.shadowColor = "white"; ctx.shadowBlur = 5; ctx.textAlign = 'center'; ctx.fillText("ï¼‹â¤ï¸", 0, -drawH - -20 - (40 - heartTimer)); ctx.restore();
            }
            if (powerUpTimer > 0) { ctx.filter = `hue-rotate(${frame * 15}deg) brightness(1.2)`; ctx.shadowBlur = 15; ctx.shadowColor = "rgba(255, 215, 0, 0.8)"; }
            ctx.drawImage(bodyImg, -drawW/2, -drawH + 5, drawW, drawH); ctx.filter = 'none';
            if (faceImg && faceImg.complete && faceSuffix !== 'n') {
                const faceW = drawW * (charData.faceScale || 0.6), faceH = faceImg.height * (faceW / faceImg.width);
                ctx.drawImage(faceImg, (drawW * (charData.faceX || 0)) - faceW / 2, (-drawH * (charData.faceY || 0.75)) - faceH / 2, faceW, faceH);
            }
            ctx.fillStyle = '#222222'; let bindSwing = tipSwing * 0.5;
            if (charData.boardType === 'double') {
                ctx.beginPath(); ctx.roundRect(-16 + bindSwing, -7.5, 17, 12, 4); ctx.fill();
                ctx.beginPath(); ctx.roundRect(2 + bindSwing, -7.5, 17, 12, 4); ctx.fill();
            }
            if (powerUpTimer > 0) {
                ctx.save(); let glow = Math.sin(frame * 0.1) * 10 + 15; ctx.shadowColor = "rgba(99, 62, 12, 0.8)"; ctx.shadowBlur = glow; ctx.fillStyle = "#ffea4d"; ctx.font = `bold ${Math.floor(drawW * 0.3)}px Inter`; ctx.textAlign = 'center'; ctx.fillText("ğŸŒŸ ç„¡æ•µä¹‹èº« ğŸŒŸ", 0, -drawH - 10 + Math.sin(frame * 0.05) * 5); ctx.font = `bold ${Math.floor(drawW * 0.35)}px serif`; ctx.fillText("ğŸ˜", 0, -drawH + 10); ctx.restore();
            } else if (stormMode) {
                ctx.save(); ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 4; ctx.fillStyle = (frame % 20 < 10) ? '#ff4d4d' : '#ffcccc'; ctx.font = `bold ${Math.floor(drawW * 0.3)}px Inter`; ctx.textAlign = 'center'; ctx.fillText("âš ï¸ æš´é¢¨é›ªä¾†è¥² âš ï¸", (Math.random()-0.5)*3, -drawH - 30); ctx.font = `bold ${Math.floor(drawW * 0.35)}px serif`; ctx.fillText("ğŸ¥¶", 0, -drawH + 10); ctx.restore();
            }
        }
        ctx.restore(); ctx.restore();

        if (stormMode) { for(let i = 0; i < 20; i++) addStormParticle(); ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.restore(); }

        if (comboCount >= 3) {
            ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); if (comboScale > 1) comboScale -= 0.05; ctx.translate(canvas.width - 25, 100); ctx.scale(comboScale, comboScale); ctx.shadowColor = '#ffeb3b'; ctx.shadowBlur = 10; ctx.font = 'bold 24px "Space Mono", monospace'; ctx.textAlign = 'right'; let grad = ctx.createLinearGradient(0, -10, 0, 10); grad.addColorStop(0, '#fff176'); grad.addColorStop(1, '#f57f17'); ctx.fillStyle = grad; ctx.fillText(`${comboCount} COMBO`, 0, 0); ctx.strokeStyle = 'white'; ctx.lineWidth = 1; ctx.strokeText(`${comboCount} COMBO`, 0, 0); ctx.restore();
        }

        ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.font = "24px serif"; ctx.textAlign = "left";
        let heartStr = ""; for(let i=0; i<MAX_LIVES; i++) heartStr += (i < lives) ? "â¤ï¸" : "ğŸ–¤";
        ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4; ctx.fillText(heartStr, 20, 45); ctx.restore();

        requestAnimationFrame(loop);
    }

    function addParticle(x, y, vx, vy) { if (particles.length < 150) particles.push({ x, y, vx, vy, life: 30, alpha: 1, isStorm: false }); }
    function addStormParticle() { if (particles.length < 350) particles.push({ x: Math.random() * (canvas.width + 600) - 200, y: Math.random() * -200, vx: -15 - Math.random() * 20, vy: 20 + Math.random() * 15, life: 30, alpha: 0.3 + Math.random() * 0.5, isStorm: true, size: 1 + Math.random() * 3 }); }
    function updateParticlesLogic() { for (let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; if (!p.isStorm) p.y -= speed * 0.5; p.life--; p.alpha = p.life / 30; if (p.life <= 0) particles.splice(i, 1); } }
    function drawParticlesRelative() { particles.forEach(p => { ctx.save(); ctx.globalAlpha = p.alpha; ctx.strokeStyle = 'white'; ctx.fillStyle = 'white'; if (p.isStorm) { ctx.lineWidth = p.size; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + p.vx * 0.8, p.y + p.vy * 0.8); ctx.stroke(); } else { ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI * 2); ctx.fill(); } ctx.restore(); }); }

function triggerGameOver() {
    running = false;
    let medal = "â„ï¸", title = "å†æ¥å†å²", colorClass = "text-gray-400";

    // å¿…é ˆå¾æœ€é«˜åˆ†é–‹å§‹åˆ¤å®šï¼
    if (score >= 1500) {
        medal = "ğŸ‘‘"; title = "å†°åŸè‡³å°Š"; colorClass = "text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white font-black italic"; 
    } else if (score >= 1000) {
        medal = "ğŸ’"; title = "ç´¢è²äºä¹‹æ˜Ÿ"; colorClass = "text-cyan-300 drop-shadow-[0_0_10px_rgba(103,232,249,0.8)]"; 
    } else if (score >= 700) {
        medal = "ğŸ¥‡"; title = "å“ˆçˆ¾æ¿±æ»‘é›ªå‚³èªª"; colorClass = "text-yellow-400";
    } else if (score >= 500) {
        medal = "ğŸ¥ˆ"; title = "å°ˆæ¥­æ»‘é›ªæ‰‹"; colorClass = "text-gray-200";
    } else if (score >= 200) {
        medal = "ğŸ¥‰"; title = "äºå¸ƒåŠ›æ–°æ‰‹"; colorClass = "text-orange-400";
    }

    document.getElementById('uiOver').classList.remove('hidden');
    document.getElementById('medalIcon').textContent = medal;
    document.getElementById('medalTitle').textContent = title;
    document.getElementById('medalTitle').className = `text-3xl font-bold mb-2 ${colorClass} drop-shadow-md`;
    
    // åˆ†æ•¸ç´€éŒ„é‚è¼¯
    let highScore = localStorage.getItem('skiHighScore') || 0;
    if (score > highScore) {
        localStorage.setItem('skiHighScore', score);
        document.getElementById('finalScore').innerHTML = `${score} <span class="text-yellow-300 text-sm ml-2">New Record!</span>`;
    } else {
        document.getElementById('finalScore').innerHTML = `${score} <br><span class="text-sm text-gray-400">æ­·å²æœ€é«˜: ${highScore}</span>`;
    }
}
    window.onresize = resize; resize(); initCharSelect();
</script>
</body>
</html>