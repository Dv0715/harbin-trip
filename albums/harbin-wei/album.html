<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>哈爾濱回憶詳情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0a0c12; color: #f5f5f7; font-family: -apple-system, system-ui, sans-serif; }
        
        /* ✅ 修改佈局：從 Column 變更為 Grid，確保「左到右、上到下」的順序 */
        .gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }
        @media (min-width: 768px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); gap: 16px; } }
        @media (min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(4, 1fr); gap: 20px; } }
        
        .gallery-item { 
            border-radius: 16px; 
            overflow: hidden; 
            background: #1c1c1e; 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
            /* 保持正方形或固定比例，讓網格整齊 */
            aspect-ratio: 1 / 1; 
        }
        .gallery-item:hover { transform: scale(1.02); z-index: 10; }

        /* 影片縮圖與播放鈕 */
        .play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            transition: background 0.3s ease;
            z-index: 5;
        }
        .gallery-item:hover .play-overlay { background: rgba(0, 0, 0, 0.4); }
        
        .play-btn {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .media-thumb { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }

        /* 燈箱樣式 */
        #lightbox { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.98); 
            z-index: 2000; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(20px); 
        }
        #lightbox.active { display: flex; }
        #lbImg, #lbVid { 
            max-width: 95%; 
            max-height: 80vh; 
            border-radius: 12px; 
            box-shadow: 0 0 60px rgba(0,0,0,1); 
        }
    </style>
</head>
<body class="antialiased">

    <nav class="sticky top-0 z-50 bg-[#0a0c12]/80 backdrop-blur-md border-b border-white/5 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center px-2">
            <a href="../../photoAlbum.html" class="text-gray-400 text-sm flex items-center gap-1 hover:text-white transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                返回總覽
            </a>
            <h1 id="albumName" class="font-bold tracking-tight">哈爾濱回憶</h1>
            <div class="w-16"></div>
        </div>
    </nav>

<div class="max-w-7xl mx-auto px-4 sm:px-6 mt-4 flex gap-3">
    <button id="filter-all" onclick="filterMedia('all')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-white text-black transition">全部</button>
    <button id="filter-image" onclick="filterMedia('image')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-white/10 text-gray-400 hover:bg-white/20 transition">只看照片</button>
    <button id="filter-video" onclick="filterMedia('video')" class="px-4 py-1.5 rounded-full text-xs font-bold bg-white/10 text-gray-400 hover:bg-white/20 transition">只看影片</button>
</div>


    <main class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- 容器類別更名為 gallery-grid -->
        <div id="galleryContainer" class="gallery-grid"></div>
        <div id="emptyState" class="hidden py-40 text-center text-gray-500">
            <p>正在同步雲端媒體...</p>
        </div>
    </main>

    <!-- 燈箱視窗 -->
    <div id="lightbox" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 bg-white/10 hover:bg-white/20 p-3 rounded-full text-white transition z-50" onclick="closeLightbox()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
        
        <div class="relative w-full flex items-center justify-center p-4">
            <img id="lbImg" class="hidden" onclick="event.stopPropagation()">
            <video id="lbVid" controls class="hidden" onclick="event.stopPropagation()"></video>
            
            <button class="absolute left-4 p-4 text-white/50 hover:text-white transition" onclick="prevImg(event)">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button class="absolute right-4 p-4 text-white/50 hover:text-white transition" onclick="nextImg(event)">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
        <p id="lbCap" class="mt-4 text-gray-400 text-sm font-medium tracking-widest"></p>
    </div>

<script>
let rawMedia = [];      // 存放原始數據
let displayMedia = [];  // 存放當前顯示（篩選後）的數據
let currentIndex = 0;

// 設置相簿標題
function setAlbumTitle() {
    const segments = window.location.pathname.split('/');
    const folderName = segments[segments.length - 2];
    const nameMap = {
        'harbin-hai': '哈爾濱・海&馨',               
        'harbin-gang': '哈爾濱・綱', 
        'harbin-yan': '哈爾濱・言',
        'harbin-wei': '哈爾濱・薇', 
        'harbin-jeff': '哈爾濱・衡',              
        'harbin-vivi': '哈爾濱・vivi',
        'harbin-xu': '哈爾濱・導遊小徐',
        'xiamen-hai_jeff': '廈門・爸&衡'
    };
    document.getElementById('albumName').textContent = nameMap[folderName] || '哈爾濱相簿';
}

async function init() {
    setAlbumTitle();
    try {
        const res = await fetch('media.json?t=' + Date.now());
        const data = await res.json();
        
        const images = (data.images || []).map(i => ({...i, type: 'image', root: 'images/'}));
        const videos = (data.videos || []).map(v => ({...v, type: 'video', root: 'videos/'}));
        
        // 自然數字排序
        rawMedia = [...images, ...videos].sort((a, b) => 
            a.url.localeCompare(b.url, undefined, { numeric: true, sensitivity: 'base' })
        );

        // 預設顯示全部
        filterMedia('all');

    } catch (err) {
        console.error("載入失敗:", err);
    }
}

function filterMedia(type) {
    const container = document.getElementById('galleryContainer');
    const emptyState = document.getElementById('emptyState');

    // 1. 更新數據源
    if (type === 'all') {
        displayMedia = [...rawMedia];
    } else {
        displayMedia = rawMedia.filter(m => m.type === type);
    }

    // 2. 更新按鈕樣式 (使用 classList.add/remove 較穩定)
    const types = ['all', 'image', 'video'];
    types.forEach(t => {
        const btn = document.getElementById(`filter-${t}`);
        if (t === type) {
            btn.classList.add('bg-white', 'text-black');
            btn.classList.remove('bg-white/10', 'text-gray-400');
        } else {
            btn.classList.remove('bg-white', 'text-black');
            btn.classList.add('bg-white/10', 'text-gray-400');
        }
    });

    // 3. 檢查是否為空
    if (displayMedia.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        emptyState.querySelector('p').textContent = `這裡目前沒有${type === 'video' ? '影片' : '照片'}...`;
        return;
    } else {
        emptyState.classList.add('hidden');
    }

    // 4. 重新渲染
    container.innerHTML = displayMedia.map((m, i) => `
        <div class="gallery-item cursor-pointer" onclick="openLightbox(${i})">
            ${m.type === 'video' ? `
                <div class="play-overlay">
                    <div class="play-btn">
                        <svg class="w-5 h-5 text-white fill-current ml-0.5" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"/>
                        </svg>
                    </div>
                </div>
                <video class="media-thumb" preload="metadata" src="${m.root}${m.url}#t=0.5"></video>
            ` : `
                <img src="${m.root}${m.url}" class="media-thumb" loading="lazy">
            `}
        </div>
    `).join('');
}

function openLightbox(index) {
    currentIndex = index;
    updateContent();
    const lb = document.getElementById('lightbox');
    lb.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function updateContent() {
    if (!displayMedia[currentIndex]) return;
    const m = displayMedia[currentIndex]; 
    const img = document.getElementById('lbImg');
    const video = document.getElementById('lbVid');
    const cap = document.getElementById('lbCap');

    img.classList.add('hidden');
    video.classList.add('hidden');
    video.pause();

    if (m.type === 'video') {
        video.src = `${m.root}${m.url}`;
        video.classList.remove('hidden');
        video.play();
    } else {
        img.src = `${m.root}${m.url}`;
        img.classList.remove('hidden');
    }
    cap.textContent = `${currentIndex + 1} / ${displayMedia.length} (${m.url})`;
}

function closeLightbox() {
    const lb = document.getElementById('lightbox');
    document.getElementById('lbVid').pause();
    lb.classList.remove('active');
    document.body.style.overflow = '';
}

// ✅ 修正：使用 displayMedia.length 確保切換邏輯正確
function nextImg(e) {
    if (e) e.stopPropagation();
    currentIndex = (currentIndex + 1) % displayMedia.length;
    updateContent();
}

function prevImg(e) {
    if (e) e.stopPropagation();
    currentIndex = (currentIndex - 1 + displayMedia.length) % displayMedia.length;
    updateContent();
}

document.addEventListener('keydown', (e) => {
    if (!document.getElementById('lightbox').classList.contains('active')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') nextImg();
    if (e.key === 'ArrowLeft') prevImg();
});

window.onload = init;
</script>
</body>
</html>