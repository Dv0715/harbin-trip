<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“ˆçˆ¾æ¿±æ”¯ç·šï½œæ»‘é›ªå¤§å†’éšª</title>


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>




    <script src="https://cdn.tailwindcss.com"></script>
    <style>

/* é«˜æ‰‹æ¦œå®¹å™¨ï¼Œç¢ºä¿å…§å®¹ä¸æœƒæº¢å‡º */
#leaderboardWrapper {
    display: flex;
    flex-direction: column;
    max-height: 55vh;
}


/* èª¿æ•´åŸæœ¬çš„æ¸…å–®ç‚ºæ²å‹•å€ */
#leaderboardList {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    padding: 10px;
    overflow-y: auto;
    
    /* ğŸ’¡ ä¿®æ”¹é€™è£¡ï¼šå°‡ 35vh æˆ– 40vh æ”¹å°ï¼Œæ¸…å–®å°±æœƒç¸®çŸ­ */
    max-height: 45vh; 
    
    flex: 1; 
}

/* å€‹äººç½®åº•å€å¡Š */
#personalRankSticky {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    background: linear-gradient(to right, rgba(0, 123, 255, 0.6), rgba(0, 86, 179, 0.8));
    border: 1px solid rgba(110, 218, 255, 0.4);
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
}

.btn-rename {
    background: #FFD700;
    color: #000;
    padding: 4px 12px;
    border-radius: 99px;
    font-size: 12px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
}
.btn-rename:active { transform: scale(0.9); }


/* ç¾åŒ–æ»¾å‹•æ¢ */
#leaderboardList::-webkit-scrollbar { width: 6px; }
#leaderboardList::-webkit-scrollbar-thumb {
    background: rgba(110, 218, 255, 0.5);
    border-radius: 10px;
}

        body { 
    margin: 0; 
    background: #000000; /* æ”¹ç‚ºç´”é»‘ï¼Œå‡¸é¡¯éŠæˆ²å€åŸŸ */
    color: white; 
    font-family: 'Inter', sans-serif; 
    overflow: hidden; 
    touch-action: none; 
    display: flex; /* è®“å…§å®¹ç½®ä¸­ */
    justify-content: center; 
}


/* éŠæˆ²è‰²èª¿æ¿¾é¡å±¤ */
#colorFilter {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 50;
    /* å¢åŠ  transition æ™‚é–“åˆ° 3 ç§’ï¼Œæœƒæ›´æœ‰é›»å½±æ„Ÿ */
    transition: background-color 3s ease, backdrop-filter 3s ease; 
}




/* 2. é™åˆ¶é›ªåœ°èƒŒæ™¯çš„å¯¬åº¦ï¼Œä½¿å…¶èˆ‡ Canvas ä¸€è‡´ */
.snow-bg {
    position: fixed; 
    top: 0; 
    left: 50%; 
    transform: translateX(-50%); /* æ°´å¹³ç½®ä¸­ */
    width: 100%; 
    max-width: 500px; /* é€™è£¡è¦è·Ÿ Canvas çš„æœ€å¤§å¯¬åº¦ä¸€è‡´ */
    height: 100%;
    background-image: linear-gradient(to bottom, #d6e2f0, #e0f2f7), url('https://i.imgur.com/P5j1w1h.png'), url('https://i.imgur.com/O61WJ7b.png');
    background-repeat: no-repeat; 
    background-size: 100% 100%, 150% auto, 120% auto; 
    background-position: center bottom; 
    z-index: -1;
    box-shadow: 0 0 50px rgba(0,0,0,1); /* å´é‚ŠåŠ ä¸Šé™°å½±ï¼Œèˆ‡é»‘åº•èåˆæ›´è‡ªç„¶ */
}
/* 3. ç¢ºä¿ Canvas ä¹Ÿæœ‰æ­£ç¢ºçš„é¡¯ç¤ºæ¨£å¼ */
#gameCanvas { 
    background: none; 
    display: block; 
    box-shadow: 0 0 30px rgba(0,0,0,0.5); /* å¢åŠ ä¸€é»é»ç«‹é«”æ„Ÿ */
} 
        .ui-panel { 
            position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: none; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); 
        }
        .btn-action { 
            pointer-events: auto; background: linear-gradient(145deg, #007bff, #0056b3); color: white; padding: 14px 40px; border-radius: 99px; font-weight: bold; font-size: 1.25rem; letter-spacing: 1px; transition: all 0.2s ease-in-out; box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4); border: none; cursor: pointer;
        }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 123, 255, 0.5); }
        .btn-action:active { transform: scale(0.95); box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); }
        #charSelect { width: 90%; max-width: 580px; margin: 10px auto 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; overflow: visible; }
        .card-container { width: 22%; aspect-ratio: 152 / 260; cursor: pointer; position: relative; perspective: 1200px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-container.is-selected .card-inner { transform: rotateY(180deg); }
        .card-container.is-selected { filter: drop-shadow(0 0 15px #e5a400); transform: scale(1.15); z-index: 10; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; background: none !important; overflow: hidden; }
        .card-front { background: linear-gradient(135deg, #1e293b, #0f172a); }
        .card-back { background: linear-gradient(135deg, #007bff, #0056b3); transform: rotateY(180deg); }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 1; display: block; }
        .card-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.75); color: white; font-size: 11px; padding: 4px 0; backdrop-filter: blur(3px); font-weight: 600; }
        #liveScore { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: bold; color: #6edaff; text-shadow: 0 0 8px rgba(110, 218, 255, 0.5); }
        /* 1. ä¿®æ­£ UI ä½ç½®ï¼Œç¢ºä¿åœ¨è¢å¹•ä¸Šå±¤ä¸”ä¸æœƒè¢«è£åˆ‡ */
.score-panel { 
    position: fixed; 
    top: 20px; 
    right: 20px; /* å¦‚æœåœ¨é›»è…¦ç‰ˆé‚„æ˜¯çœ‹ä¸åˆ°ï¼Œè«‹æ”¹ç‚º right: calc(50% - 230px); è®“å®ƒè²¼è‘—éŠæˆ²é‚Šç·£ */
    background: rgba(0, 0, 0, 0.6); /* åŠ æ·±èƒŒæ™¯ï¼Œè®“æ–‡å­—æ›´æ˜é¡¯ */
    backdrop-filter: blur(8px); 
    border: 1px solid rgba(255, 255, 255, 0.2); 
    padding: 8px 20px; 
    border-radius: 99px; 
    z-index: 2000; /* æé«˜å±¤ç´š */
    display: flex; 
    align-items: center; 
    gap: 8px; 
}

.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }


@keyframes score-jump {
    0% { transform: scale(1); color: #6edaff; }
    30% { transform: scale(1.5); color: #FFD700; text-shadow: 0 0 20px #FFD700; }
    100% { transform: scale(1); color: #6edaff; }
}
.score-active { animation: score-jump 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes score-zoom-in {
    0% { transform: scale(0.5); opacity: 0; }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}
/* æ©˜ç´…è‰²èˆ‡è·³å‹•å‹•ç•« */
.score-highlight-group {
    color: #ffc422; /* æ©˜ç´…è‰²ï¼Œä»‹æ–¼æ©˜èˆ‡ç´…ä¹‹é–“ */
    font-weight: 900;
    text-shadow: 0 0 15px rgba(255, 87, 34, 0.4);
    display: inline-block;
    animation-fill-mode: forwards; /* ğŸ’¡ åŠ å…¥é€™ä¸€è¡Œï¼Œé˜²æ­¢è·³å‹• */
    animation: score-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes score-bounce {
    0% { transform: scale(0); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}

/* è®“æœ€çµ‚å¾—åˆ†å››å€‹å­—ç¨å¾®å°ä¸€é»ï¼Œæ•¸å­—å¤§ä¸€é»ï¼Œæ›´æœ‰å±¤æ¬¡ */
.score-label {
    font-size: 1.5rem;
    vertical-align: middle;
}
.score-number {
    font-size: 2rem;
    vertical-align: middle;
    margin-left: 5px;
}



/* 2. é‡å°é›»è…¦ç‰ˆå¯¬è¢å¹•çš„èª¿æ•´ */
@media (min-width: 600px) {
    .score-panel {
        right: calc(50% - 240px); /* è®“åˆ†æ•¸é¢æ¿è²¼åœ¨ 500px éŠæˆ²ç•«é¢çš„å³å´é‚Šç·£å…§ */
    }
}
        .score-panel::before { content: "åˆ†æ•¸"; font-size: 10px; font-weight: 900; color: rgba(255, 255, 255, 0.6); letter-spacing: 1px; }
        h1.title-bounce { font-weight: 900; font-style: italic; color: #93c5fd; text-shadow: 2px 2px 0px #1e3a8a, 4px 4px 15px rgba(0,0,0,0.5); }
        
        @keyframes medal-zoom {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        #medalIcon { animation: medal-zoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ffeb3b; }
            100% { transform: scale(1); }
        }
        .score-bounce { animation: score-pop 0.3s ease-out; }

        canvas { touch-action: none; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0); }
    </style>
</head>
<body>

    <div class="snow-bg"></div>
    <div id="uiStart" class="ui-panel pointer-events-auto">
        <h1 class="text-5xl font-black italic mb-3 text-blue-300 title-bounce">æ»‘é›ªæŒ‘æˆ°GOï¼ğŸ§Š</h1>
        <p class="text-gray-300 mb-10 text-sm tracking-widest uppercase">â„ï¸ Yabuli Special Edition â„ï¸</p>
        <div id="charSelect"></div>
        <button onclick="start()" class="btn-action text-xl px-12 py-4">é–‹å§‹æ»‘é›ª</button>
    </div>

<div id="uiOver" class="ui-panel hidden pointer-events-auto text-center">
    
    <div id="gameOverResult" class="flex flex-col items-center">
        <div id="medalIcon" class="text-8xl mb-4 drop-shadow-lg"></div>
        <h3 class="text-1xl font-bold mb-2 drop-shadow-md text-gray-400">ç²å¾—ç¨±è™Ÿ</h3>
        <div id="medalTitle" class="text-3xl font-bold mb-2 drop-shadow-md"></div>
        
        <h2 class="text-5xl font-black  mb-2 italic">æ‘”å€’äº†ï¼</h2>   
        <div class="mb-4">
            <p class="text-2xl text-yellow-400 ">æœ€çµ‚å¾—åˆ†: <span id="finalScore" class="text-yellow-400  font-bold">0</span></p>
            </div>
        <button onclick="showLeaderboardPage()" class="btn-action bg-blue-500 px-12 mt-4">æŸ¥çœ‹æ’å ğŸ†</button>
    </div>

    <div id="gameOverLeaderboard" class="hidden flex flex-col items-center w-full px-4">
        <h3 class="text-blue-300 font-bold mb-2">ğŸ† äºå¸ƒåŠ›é«˜æ‰‹æ¦œ</h3>
        <div id="leaderboardWrapper" class="w-full">
            <div id="leaderboardList" class="text-sm custom-scrollbar">
                è¼‰å…¥ä¸­...
            </div>
            <div id="personalRankSticky"></div>
        </div>
        <button onclick="location.reload()" class="btn-action bg-red-600 px-12 mt-6">é‡æ–°æŒ‘æˆ°</button>
    </div>

</div>

    <div class="score-panel"><span id="liveScore">0</span></div>

<div id="pauseBtn" class="fixed top-[20px] left-[50%] translate-x-[-50%] z-[2000] cursor-pointer opacity-70 hover:opacity-100 hidden" onclick="togglePause()">
    <div class="bg-black/40 backdrop-blur-md border border-white/20 p-2 rounded-full px-4 text-xs font-bold tracking-widest">
        â¸STOP
    </div>
</div>

<div id="uiPause" class="ui-panel hidden pointer-events-auto text-center">
    <h2 class="text-5xl font-black text-blue-300 mb-10 italic">æš«åœä¸­</h2>
    <div class="flex flex-col gap-4">
        <button onclick="togglePause()" class="btn-action bg-blue-600 px-12">ç¹¼çºŒæ»‘é›ª</button>
        <button onclick="location.reload()" class="btn-action bg-gray-600 px-12">é›¢é–‹éŠæˆ²</button>
    </div>
</div>

<div id="colorFilter"></div>
    <canvas id="gameCanvas"></canvas>


<script>


  const firebaseConfig = {
    apiKey: "AIzaSyAzWWPB0u797OIEO7uF5zVtujao3cLc2qk",
    authDomain: "harbinskigame.firebaseapp.com",
    databaseURL: "https://harbinskigame-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "harbinskigame",
    storageBucket: "harbinskigame.firebasestorage.app",
    messagingSenderId: "440536889148",
    appId: "1:440536889148:web:ba6502acabdfd1cf311039",
    measurementId: "G-JD786HV9CS"
  };



  
// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database(); // è®“å¾Œé¢çš„ database.ref èƒ½å¤ é‹ä½œ

// åœ¨ start() è£¡é¢
const savedName = localStorage.getItem('skiPlayerName');
window.playerName = savedName || prompt("è«‹è¼¸å…¥ä½ çš„æ»‘é›ªå¤§åï¼š", "ç¥ç§˜æ»‘é›ªå®¢") || "åŒ¿åç©å®¶";
localStorage.setItem('skiPlayerName', window.playerName);

// åœ¨ script é ‚éƒ¨ï¼ˆè®Šæ•¸å®£å‘Šå€ï¼‰åŠ å…¥é€™è¡Œ
let currentScoreKey = null;

    let jumpOffset = 0, jumpV = 0, isJumping = false;
    let items = [], particles = [], obstacles = [], snowballs = [];
    let powerUpTimer = 0, stormMode = false, stormTimer = 0, friction = 0.12; 
    let selectedIdx = 4, running = false, score = 0, frame = 0, speed = 7, px, py = 150, tx;
    let comboCount = 0, comboScale = 1, lives = 5, heartTimer = 0, invincibilityTimer = 0;
    const MAX_LIVES = 5;
    let highScore = localStorage.getItem('skiHighScore') || 0;
    let isPaused = false; // æ–°å¢é€™è¡Œ
    let snowHitTimer = 0; // æ–°å¢ï¼šé›ªå †æ’æ“Šè¡¨æƒ…è¨ˆæ™‚å™¨

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const CHARS = [
        { name: "çˆ¸", file: "1", boardType: "double", size: 55, faceY: 0.562, faceScale: 0.5, faceX: -0.01 },
        { name: "åª½", file: "2", boardType: "double", size: 55, faceY: 0.549, faceScale: 0.5, faceX: 0.005 },
        { name: "å“¥", file: "3", boardType: "single", size: 55, faceY: 0.575, faceScale: 0.49, faceX: -0.01 },
        { name: "è¨€", file: "4", boardType: "double", size: 55, faceY: 0.62, faceScale: 0.5, faceX: 0.007 },
        { name: "å¦¹", file: "5", boardType: "double", size: 55, faceY: 0.525, faceScale: 0.5, faceX: 0.005 },
        { name: "å¼Ÿ", file: "6", boardType: "single", size: 55, faceY: 0.569, faceScale: 0.496, faceX: -0.04 },
        { name: "Vivi", file: "7", boardType: "single", size: 55, faceY: 0.6065, faceScale: 0.5, faceX: -0.005 }
    ];

const FOOD_FILES = ['1.webp', '2.webp', '3.webp', '4.webp'];
const foodImages = {}; // ç”¨ä¾†å­˜æ”¾é è¼‰å…¥çš„åœ–ç‰‡




    const FACES = ['n', 's', 'h', 'e', 'd', 'b']; 
    const OBSTACLE_FILES = ['1.webp', '2.webp', '3.webp'];
    const charImages = {}, obsImages = {};
    const OBSTACLE_CONFIG = { 
        '1.webp': { w: 70, h: 60, r: 35 }, 
        '2.webp': { w: 50, h: 50, r: 35 }, 
        '3.webp': { w: 70, h: 90, r: 35 },
        'ramp.webp': { w: 110, h: 110, r: 40 }, // æ–°å¢ï¼šè®“è·³å°å¯¬ä¸€é»ï¼Œå¥½è¸©ï¼
        'snow_pile.webp': { w: 100, h: 100, r: 30 } // ğŸ’¡ æ–°å¢é›ªå †é…ç½®
    };

function preloadAssets() {
        // --- è§’è‰²åœ–ç‰‡ ---
        CHARS.forEach(c => {       
            const mainImg = new Image(); mainImg.src = `images/ski/${c.file}.webp`;
            charImages[c.file] = mainImg;
            FACES.forEach(f => {
                const img = new Image(); img.src = `images/ski/${c.file}_${f}.webp`;
                charImages[`${c.file}_${f}`] = img;
            });
        });

        // --- éšœç¤™ç‰©èˆ‡è·³å°åœ–ç‰‡ ---
        // æŠŠ ramp.webp è·Ÿæ™®é€šéšœç¤™ç‰©æ”¾åœ¨ä¸€èµ·è™•ç†
        const allObsFiles = [...OBSTACLE_FILES, 'ramp.webp', 'snow_pile.webp'];
        
        allObsFiles.forEach(file => {
            const img = new Image(); 
            img.src = `images/obs/${file}`; // çµ±ä¸€å¾ images/obs/ è®€å–
            obsImages[file] = img;
        });

        // --- é£Ÿç‰©åœ–ç‰‡ ---
        FOOD_FILES.forEach(file => {
            const img = new Image();
            img.src = `images/food/${file}`;
            foodImages[file] = img;
        });
    }
    preloadAssets();

    function updateScore(points) {
        const multiplier = 1 + Math.floor(comboCount / 10);
        const oldScore = score;
        score += (points * multiplier);



// å‰›ç ´ç´€éŒ„çš„ç¬é–“
    if (oldScore <= highScore && score > highScore && highScore > 0) {
        // å¯ä»¥åœ¨é€™è£¡åŠ ä¸€å€‹æ¨™è¨˜ï¼Œè®“ loop ç•«å‡ºä¸€å€‹æ…¶ç¥ç‰¹æ•ˆ
        console.log("New Record Burst!");
    }

        if (points === 1) { comboCount++; comboScale = 1.3; }
        const liveScoreEl = document.getElementById('liveScore');
        if (liveScoreEl) liveScoreEl.textContent = score;
        const scoreEl = document.querySelector('.score-panel');
        if (scoreEl) { scoreEl.classList.remove('score-bounce'); void scoreEl.offsetWidth; scoreEl.classList.add('score-bounce'); }
    }

    function initCharSelect() {
        const menu = document.getElementById('charSelect');
        menu.innerHTML = CHARS.map((c, i) => `
            <div class="card-container ${i === selectedIdx ? 'is-selected' : ''}" onclick="selectChar(${i})" id="char-card-${i}">
                <div class="card-inner">
                    <div class="card-front"><img src="images/char/${c.file}.webp" class="card-img"><div class="card-label">${c.name}</div></div>
                    <div class="card-back"><img src="images/char/${c.file}_real.webp" class="card-img" onerror="this.src='https://placehold.co/152x260/0056b3/white?text=${c.name}Real'"><div class="card-label">READY!</div></div>
                </div>
            </div>
        `).join('');
    }

    window.selectChar = (i) => {
        document.querySelectorAll('.card-container').forEach(el => el.classList.remove('is-selected'));
        selectedIdx = i;
        document.getElementById(`char-card-${i}`).classList.add('is-selected');
    };

    function resize() {
        canvas.width = Math.min(window.innerWidth, 500); canvas.height = window.innerHeight;
        px = tx = canvas.width / 2;
    }

function start() {
    resize(); 
    document.getElementById('uiStart').classList.add('hidden');
    document.getElementById('uiOver').classList.add('hidden');
    document.getElementById('pauseBtn').classList.remove('hidden'); 
    
    // ç§»é™¤è©¢å•å§“åçš„é‚è¼¯ï¼Œæ”¹ç‚ºéŠæˆ²çµæŸå¾Œåˆ¤æ–·
    window.playerName = "åŒ¿åç©å®¶"; 

    isPaused = false;
    running = true; score = 0; lives = 5; comboCount = 0; speed = 7; 
    obstacles = []; items = []; particles = []; snowballs = [];
    px = tx = canvas.width / 2;
    loop();
}

    const move = (e) => {
        if(!running) return;
        let clientX = (e.touches && e.touches.length > 0) ? e.touches[0].clientX : e.clientX;
        const r = canvas.getBoundingClientRect();
        tx = Math.max(40, Math.min(canvas.width-40, (clientX - r.left) * (canvas.width / r.width)));
    };
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', move, { passive: false });
    window.addEventListener('touchstart', move, { passive: false });

    function loop() {
        // --- è·³èºç‰©ç†é‚è¼¯ ---
if (isJumping) {
    jumpOffset += jumpV;
    jumpV -= 0.6; // é‡åŠ›åŠ é€Ÿï¼Œæ•¸å€¼è¶Šå¤§è·³å¾—è¶Šå¿«ï¼Œè½åœ°è¶Šé‡
    if (jumpOffset <= 0) {
        jumpOffset = 0;
        jumpV = 0;
        isJumping = false;
        // è½åœ°ç¬é–“å¯ä»¥åŠ ä¸€é»ç²’å­ç‰¹æ•ˆï¼Œæ›´æœ‰åŠ›é“
        for(let i=0; i<8; i++) addParticle(px, py + 25, (Math.random()-0.5)*10, Math.random()*5);
    }
}
        if(!running || isPaused) return; // ä¿®æ”¹é€™è¡Œï¼ŒåŠ å…¥ isPaused åˆ¤å®š
        frame++; 




        if (powerUpTimer > 0) { powerUpTimer--; friction = 0.15; }
        else if (stormMode) { speed += 0.03; friction = 0.06; }
        else { friction = 0.12; }
        
        px += (tx - px) * friction; 
        ctx.clearRect(0, 0, canvas.width, canvas.height);



        stormTimer++;
        if (stormTimer % 1200 === 0) stormMode = true; 
        if (stormMode && stormTimer % 1200 === 300) stormMode = false; 

        // 1. é€Ÿåº¦ç·š
        ctx.save();
        ctx.strokeStyle = '#c5e2f7'; ctx.lineWidth = 2;
        for(let i=0; i<6; i++) {
            let ly = (frame * speed * 0.8 + i * 150) % (canvas.height + 150);
            ctx.beginPath(); ctx.moveTo(i * canvas.width / 5, ly - 50); ctx.lineTo(i * canvas.width / 5, ly + 50); ctx.stroke();
        }
        ctx.restore();



// --- 2.1 çµ±ä¸€é“å…·ç”Ÿæˆå…¥å£ (æ©Ÿç‡ï¼šæ˜Ÿæ˜Ÿ > æ„›å¿ƒ > ç¾é£Ÿ) ---
        if (frame % 150 === 0) { // ç¨å¾®åŠ å¿«ç”Ÿæˆç¯€å¥ (ç´„ 2.5 ç§’ä¸€æ¬¡)
            const rand = Math.random();
            let type = null, file = null;

            if (rand < 0.40) {         // 0% ~ 40% (40% æ©Ÿç‡)
                type = 'â­'; 
            } else if (rand < 0.70) {  // 40% ~ 70% (30% æ©Ÿç‡)
                type = 'â¤ï¸'; 
            } else if (rand < 0.95) {  // 70% ~ 95% (25% æ©Ÿç‡)
                type = 'FOOD'; 
                file = FOOD_FILES[Math.floor(Math.random() * FOOD_FILES.length)];
            }
            // å‰©ä¸‹ 5% æ©Ÿç‡ç©ºç›¤ï¼Œå¢åŠ éš¨æ©Ÿæ„Ÿ

            if (type) {
                items.push({ 
                    x: Math.random() * (canvas.width - 80) + 40, 
                    y: canvas.height + 100, 
                    type: type,
                    file: file,
                    rotate: 0 
                });
            }
        }

        // --- 2.2 çµ±ä¸€è™•ç†æ‰€æœ‰é“å…· (ç§»å‹•ã€ç¹ªè£½ã€ç¢°æ’) ---
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i]; 
            item.y -= speed; 

            if (item.type === 'FOOD' && item.file) {
                // ç¹ªè£½ï¼šç¾é£Ÿåœ–ç‰‡ (å¸¶æœ‰å‘¼å¸è·³å‹•ç‰¹æ•ˆ)
                const img = foodImages[item.file];
                if (img && img.complete) {
                    ctx.save();
                    ctx.shadowColor = "rgba(255, 223, 0, 0.9)";
                    ctx.shadowBlur = 15 + Math.sin(frame * 0.1) * 8; 
                    item.rotate = (item.rotate || 0) + 0.05;
                    const bobbing = Math.sin(frame * 0.1) * 5;
                    const pulse = 1.1 + Math.sin(frame * 0.1) * 0.2; 
                    ctx.translate(item.x, item.y + bobbing);
                    ctx.rotate(Math.sin(item.rotate) * 0.2); 
                    ctx.scale(pulse, pulse);
                    ctx.drawImage(img, -22, -22, 44, 44); 
                    ctx.restore();
                }
            } else {
                // ç¹ªè£½ï¼šæ˜Ÿæ˜Ÿ â­ èˆ‡æ„›å¿ƒ â¤ï¸ (Emoji ç‰ˆ)
                ctx.save();
                ctx.font = '40px serif'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                // è®“ Emoji ä¹Ÿæœƒä¸Šä¸‹æµ®å‹•è·Ÿç™¼å…‰
                //ctx.shadowColor = (item.type === 'â­') ? "rgba(255, 255, 0, 0.8)" : "rgba(255, 0, 0, 0.8)";
                //ctx.shadowBlur = 15;
                ctx.fillText(item.type, item.x, item.y + Math.sin(frame * 0.1) * 5);
                ctx.restore();
            }

// ç¢°æ’åµæ¸¬ (çµ±ä¸€åŠå¾‘ 50)
            if (Math.hypot(px - item.x, py - item.y) < 50) { 
                if (item.type === 'â¤ï¸') {
                    if (lives < MAX_LIVES) lives++; 
                    heartTimer = 40; // è·³å‡º +â¤ï¸
                } else if (item.type === 'â­') {
                    powerUpTimer = 180; // é€²å…¥ç„¡æ•µï¼Œä¸åŠ åˆ†
} else if (item.type === 'FOOD') {
                    score += 30; 
                    heartTimer = 40; // è§¸ç™¼é ­é ‚é£„å­—
                    
                    // --- ğŸ’¡ å³ä¸Šè§’è·³å‹•ç‰¹æ•ˆ ---
                    const scoreEl = document.getElementById('liveScore');
                    if (scoreEl) {
                        scoreEl.textContent = score;
                        scoreEl.classList.remove('score-active'); // å…ˆç§»é™¤èˆŠçš„
                        void scoreEl.offsetWidth; // ğŸ’¡ é—œéµï¼šå¼·åˆ¶é‡æ–°æ¸²æŸ“
                        scoreEl.classList.add('score-active'); // é‡æ–°åŠ å…¥å‹•ç•«
                    }
                }
// ğŸ’¡ é—œéµï¼šåƒåˆ°æ±è¥¿å¾Œã€Œå¿…é ˆã€ç«‹åˆ»å¾é™£åˆ—ç§»é™¤ï¼Œå¦å‰‡ä¸‹ä¸€å¹€æœƒå†åŠ ä¸€æ¬¡åˆ†ï¼
                    items.splice(i, 1); 
                } else if (item.y < -150) { 
                    items.splice(i, 1); // é£›å‡ºç•«é¢ä¹Ÿè¦ç§»é™¤
                }
            }


// --- 3. éšœç¤™ç‰©ã€é›ªå †èˆ‡è·³å°ç”Ÿæˆ ---
let spawnRate = Math.max(15, 40 - Math.floor(speed * 0.7));
if (frame % spawnRate === 0) {
    let rand = Math.random();
    let x = Math.random() * (canvas.width - 80) + 40;
    let y = canvas.height + 100;

    // å„ªå…ˆåˆ¤å®šï¼šè·³å°ç”Ÿæˆ (150åˆ†ä»¥å¾Œï¼Œæ©Ÿç‡ 15%)
    if (score >= 150 && !stormMode && rand <= 0.15) {
        obstacles.push({ 
            x: x, y: y, 
            file: 'ramp.webp', 
            type: 'ramp' 
        });

        // 40% æ©Ÿç‡åœ¨è·³å°ä¸Šæ–¹ç”Ÿæˆç©ºä¸­æ˜Ÿæ˜Ÿ
        if (Math.random() < 0.4) {
            items.push({
                x: x, y: y - 70, 
                type: 'â­',
                isHigh: true   
            });
        }
    } 
    // æ¬¡è¦åˆ¤å®šï¼šé›ªå †ç”Ÿæˆ (100åˆ†ä»¥å¾Œï¼Œæ©Ÿç‡ 20%)
    else if (score >= 40 && rand <= 0.35) { // é€™è£¡ 0.35 æ˜¯ç´¯åŠ æ©Ÿç‡ (0.15~0.35 å€é–“)
        obstacles.push({ 
            x: x, y: y, 
            file: 'snow_pile.webp', 
            type: 'obstacle' 
        });
    } 
    // åŸºæœ¬åˆ¤å®šï¼šæ™®é€šéšœç¤™ç‰© (ä»»ä½•åˆ†æ•¸ï¼Œå‰©ä¸‹çš„æ©Ÿç‡)
    else {
        const file = OBSTACLE_FILES[Math.floor(Math.random() * OBSTACLE_FILES.length)];
        obstacles.push({ 
            x: x, y: y, 
            file: file,
            type: 'obstacle' 
        });
    }
}

        // --- è™•ç†æ‰€æœ‰ç‰©ä»¶çš„ç§»å‹•èˆ‡ç¢°æ’ ---
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i]; 
            o.y -= speed;

            const config = (o.type === 'ramp') ? { w: 70, h: 70, r: 30 } : (OBSTACLE_CONFIG[o.file] || { w: 60, h: 60, r: 35 });
            const img = obsImages[o.file];

            ctx.save();
            
            if (o.type === 'ramp' && (!img || !img.complete)) {
                // æ¸¬è©¦ç”¨ï¼šé‚„æ²’æ›åœ–å‰ç•«ä¸€å€‹è—è‰²è·³å°è‰²å¡Š
                ctx.fillStyle = '#3498db';
                ctx.fillRect(o.x - config.w/2, o.y - config.h/2, config.w, config.h);
            } else if (img && img.complete) {
                if (powerUpTimer > 0 && o.type !== 'ramp' && Math.hypot(px - o.x, py - o.y) < config.r + 20) ctx.globalAlpha = 0.3;
                ctx.drawImage(img, o.x - config.w / 2, o.y - config.h / 2, config.w, config.h);
            }
            ctx.restore();

            // ç¢°æ’åˆ¤å®š
            const dist = Math.hypot(px - o.x, py - o.y);
            if (dist < config.r + 5) {
                if (o.type === 'ramp') {
                    if (!isJumping) {
                        isJumping = true;
                        jumpV = 12; // è·³èºåŠ›åº¦
                        updateScore(50);
                        obstacles.splice(i, 1);
                    }
} else if (o.file === 'snow_pile.webp') { 
    // ã€é›ªå †ç¢è£‚é‚è¼¯ã€‘
    // ğŸ’¡ é—œéµï¼šåªæœ‰åœ¨ã€Œéç„¡æ•µç‹€æ…‹ã€ä¸‹æ‰æœƒæ–· Combo
    if (powerUpTimer <= 0) {
        comboCount = 0; 
        snowHitTimer = 20; // é¡¯ç¤ºå—é©šè¡¨æƒ…
    }
    
    // ç„¡è«–æœ‰ç„¡ç„¡æ•µï¼Œé›ªå †éƒ½æœƒæ¶ˆå¤±ä¸¦å™´ç™¼ç²’å­ï¼ˆé€™æ¨£æ‰å¸¥ï¼ï¼‰
    obstacles.splice(i, 1);
            // ç”Ÿæˆç™½è‰²ç²’å­å™´ç™¼
            for(let j=0; j < 25; j++) {
                particles.push({
        x: o.x,
        y: o.y,
        // åŠ å¤§çˆ†ç™¼åˆé€Ÿ
        vx: (Math.random() - 0.5) * 18, 
        vy: (Math.random() - 0.8) * 15, // è®“å¤§éƒ¨åˆ†ç²’å­å…ˆå‘ä¸Šå™´å†æ‰ä¸‹ä¾†
        life: 30 + Math.random() * 20,
        alpha: 1,
        size: 3 + Math.random() * 5,    // è®“ç²’å­å¤§å°ä¸ä¸€ï¼Œæ›´æœ‰ç¢å¡Šæ„Ÿ
        isTrack: false,
        isSnowBurst: true,              // æ–°å¢æ¨™è¨˜ï¼Œç”¨ä¾†å¥—ç”¨ç‰©ç†é‚è¼¯
        gravity: 0.5                    // çµ¦äºˆé‡åŠ›å¸¸æ•¸
    });

            }
                } else if (powerUpTimer <= 0 && invincibilityTimer <= 0 && !isJumping) {
                    lives--; 
                    comboCount = 0; 
                    obstacles.splice(i, 1); 
                    invincibilityTimer = 60;
                    if (lives <= 0) triggerGameOver(); 
                }
            } else if (o.y < -150) { 
                obstacles.splice(i, 1); 
                if (o.type !== 'ramp') updateScore(1); 
            }
        }






// --- 4. é›ªçƒæç¤ºèˆ‡ç”Ÿæˆé‚è¼¯ ---
        if (score >= 300) {
            // æç¤ºæ–‡å­—ï¼šç¢ºä¿é€™æ®µåœ¨ loop è£¡æœƒè¢«åŸ·è¡Œåˆ°
            if (score < 315) {
                ctx.save(); 
                ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®åº§æ¨™ç³»ç¢ºä¿ç•«åœ¨è¢å¹•ä¸­å¤®
                ctx.fillStyle = (frame % 20 < 10) ? "#ffffff" : "#3b82f6";
                ctx.font = "bold 35px Inter"; 
                ctx.textAlign = "center"; 
                ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 10;
                ctx.fillText("âš ï¸ æ³¨æ„å·¨å¤§é›ªçƒ âš ï¸", canvas.width / 2, canvas.height / 2); 
                ctx.restore();
            }

            // æ¯ 350 å¹€ç”Ÿæˆä¸€é¡†æ–°é›ªçƒ
            if(frame % 350 === 0) {
                snowballs.push({ x: Math.random() * (canvas.width - 100) + 50, y: canvas.height + 100, radius: 15, growth: 0.15 });
            }
        }

        // ç§»å‹•èˆ‡ç¢°æ’åˆ¤å®š (æ”¾åœ¨ score >= 300 ä¹‹å¤–ï¼Œç¢ºä¿ç”¢ç”Ÿçš„é›ªçƒæœƒæŒçºŒç§»å‹•)
for (let i = snowballs.length - 1; i >= 0; i--) {
            let b = snowballs[i];
            b.y -= speed * 0.7; b.radius += b.growth;
            
            ctx.save();
            // A. æ–°å¢é›ªçƒåº•éƒ¨çš„æ·±è‰²æŠ•å½±
            ctx.shadowColor = "rgba(0, 30, 60, 0.4)"; // æ·±è—è‰²é™°å½±ï¼Œæ¯”é»‘å½±æ›´è‡ªç„¶
            ctx.shadowBlur = b.radius * 0.5;
            ctx.shadowOffsetY = b.radius * 0.3;

            // B. å¼·åŒ–é›ªçƒæœ¬é«”çš„ç«‹é«”æ¼¸å±¤
            let grad = ctx.createRadialGradient(
                b.x - b.radius * 0.3, b.y - b.radius * 0.3, b.radius * 0.1, 
                b.x, b.y, b.radius
            );
            grad.addColorStop(0, '#ffffff');    // å—å…‰é¢
            grad.addColorStop(0.7, '#e0f2ff');  // ä¸­é–“è‰²
            grad.addColorStop(1, '#a1c4fd');    // èƒŒå…‰æ·±è‰²é‚Šç·£ (åŠ æ·±è—è‰²èª¿)
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // C. åŠ ä¸Šæ›´æ˜é¡¯çš„æ—‹è½‰ç·šæ¢æ„Ÿ (é›ªæ²å‹•çš„ç´‹è·¯)
            ctx.shadowBlur = 0; // æ¸…é™¤æŠ•å½±ï¼Œé¿å…ç´‹è·¯è®Šæ¨¡ç³Š
            ctx.strokeStyle = 'rgba(0, 80, 150, 0.2)'; 
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius * 0.7, frame * 0.1, frame * 0.1 + Math.PI * 0.4);
            ctx.stroke();
            ctx.restore();

            // ç¢°æ’åˆ¤å®šç¶­æŒåŸæ¨£...
            if (powerUpTimer <= 0 && invincibilityTimer <= 0 && Math.hypot(px - b.x, py - b.y) < b.radius + 10) {
                lives--; comboCount = 0; snowballs.splice(i, 1); invincibilityTimer = 60;
                if (lives <= 0) triggerGameOver();
            } else if(b.y < -150) { 
                snowballs.splice(i, 1); updateScore(10); 
            }
        }

        // ç¹ªè£½èˆ‡ç§»å‹•é‚è¼¯ï¼šé€™æ®µå¿…é ˆæ”¾åœ¨ score >= 300 çš„å¤§æ‹¬è™Ÿã€Œå¤–é¢ã€ï¼Œ
        // é€™æ¨£ä¸€æ—¦é›ªçƒç”¢ç”Ÿäº†ï¼Œå³ä½¿åˆ†æ•¸ç¹¼çºŒå¢åŠ ï¼Œå®ƒå€‘ä¹ŸæœƒæŒçºŒç§»å‹•ã€‚
        for (let i = snowballs.length - 1; i >= 0; i--) {
            let b = snowballs[i];
            b.y -= speed * 0.7; // å‘ä¸Šç§»å‹•ï¼ˆç‡Ÿé€ å‘ä¸‹è¡çš„æ•ˆæœï¼‰
            b.radius += b.growth; // è¶Šæ»¾è¶Šå¤§
            
            ctx.save();
            let grad = ctx.createRadialGradient(b.x - b.radius/3, b.y - b.radius/3, b.radius/4, b.x, b.y, b.radius);
            grad.addColorStop(0, '#ffffff'); 
            grad.addColorStop(1, '#d1e9ff');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // é›ªçƒè¡¨é¢çš„æ—‹è½‰ç·šæ¢æ„Ÿ
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.radius * 0.8, 0, Math.PI * 0.5);
            ctx.stroke();
            ctx.restore();

            // ç¢°æ’åµæ¸¬
            if (powerUpTimer <= 0 && invincibilityTimer <= 0 && Math.hypot(px - b.x, py - b.y) < b.radius + 10) {
                lives--; 
                comboCount = 0; 
                snowballs.splice(i, 1); 
                invincibilityTimer = 60;
                if (lives <= 0) triggerGameOver();
            } else if(b.y < -150) { 
                // é›ªçƒé›¢é–‹ç•«é¢
                snowballs.splice(i, 1); 
                updateScore(10); 
            }
        }

// --- æ–°å¢ï¼šæ»‘é›ªç—•è·¡ç²’å­ç”Ÿæˆ ---
if (frame % 2 === 0) {
    particles.push({ 
        x: px, // å­˜å„²ç•¶ä¸‹äººç‰©çš„çµ•å° X
        y: py + 25, 
        vx: 0, 
        vy: 0, 
        life: 30, 
        alpha: 0.3, 
        isTrack: true, 
        width: CHARS[selectedIdx].boardType === 'double' ? 12 : 22 
    });
}


// --- 5.1 æ»‘é›ªç—•è·¡èˆ‡æ¿€èµ·é›ªèŠ±ç”Ÿæˆ (ç¢ºä¿é€™æ®µç¨ç«‹åœ¨æœ€å¤–å±¤) ---
        if (frame % 2 === 0) {
            // 1. ç”Ÿæˆåœ°é¢æ»‘ç—• (isTrack: true)
            particles.push({ 
                x: px, 
                y: py + 25, 
                vx: 0, 
                vy: 0, 
                life: 35, 
                alpha: 0.3, 
                isTrack: true, 
                width: CHARS[selectedIdx].boardType === 'double' ? 12 : 22 
            });

            // 2. ç”Ÿæˆå‘å·¦å³é£›æ•£çš„é›ªèŠ± (isTrack: false)
            const spread = 15; 
            [-1, 1].forEach(side => {
                particles.push({
x: px + (side * spread) + (Math.random() - 0.5) * 5, // éŒ¯é–‹ä¸­å¿ƒé»
                    y: py + 20,
                    vx: side * (1 + Math.random() * 3),// å·¦å´ç²’å­å¾€å·¦è·‘ (è² æ•¸)ï¼Œå³å´å¾€å³è·‘ (æ­£æ•¸)
                    vy: (Math.random() * 2),            // ç¨å¾®å¾€ä¸‹æ‰ä¸€é»
                    life: 12 + Math.random() * 8,       // å™´æ¿ºé›ªèŠ±å£½å‘½çŸ­ä¸€é»ï¼Œæ›´æœ‰çˆ†ç™¼æ„Ÿ
                    alpha: 0.6,
                    isTrack: false,
                    isStorm: false
                });
            });
        }




        // 5. ç©å®¶æ¸²æŸ“
        updateParticlesLogic();
        drawParticlesRelative();
        ctx.save(); 
        if (invincibilityTimer > 0) { invincibilityTimer--; if (frame % 6 < 3) ctx.globalAlpha = 0.2; }
        if (stormMode) ctx.translate((Math.random()-0.5)*5, (Math.random()-0.5)*5);
       

// --- ğŸ’¡ ç¬¬ä¸€æ­¥ï¼šå…ˆç•«åœ°é¢çš„ã€Œå‹•æ…‹é™°å½±ã€ ---
        // é™°å½±è¦ç•«åœ¨ translate(px, py) ä¹‹å‰ï¼Œæˆ–æ˜¯ä½¿ç”¨ç›¸å°åº§æ¨™
        ctx.save();
        ctx.translate(px, py + 0); // é™°å½±ä½æ–¼è§’è‰²è…³åº•ä½ç½®
        ctx.fillStyle = "rgba(0, 0, 0, 0.2)"; // æ·¡æ·¡çš„é»‘è‰²
        
        // é™°å½±éš¨é«˜åº¦ç¸®å°ï¼šè·³å¾—è¶Šé«˜ï¼Œé™°å½±è¶Šå°ã€è¶Šæ·¡
        let shadowScale = Math.max(0.4, 1 - (jumpOffset / 500)); 
        ctx.globalAlpha = shadowScale * 0.3; // è¶Šé«˜è¶Šé€æ˜
        ctx.beginPath();
        // ç•«ä¸€å€‹æ©¢åœ“ä½œç‚ºé™°å½±
        ctx.ellipse(0, 0, 25 * shadowScale, 8 * shadowScale, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();

       
// --- ğŸ’¡ é—œéµä¿®æ­£ï¼šå°‡é«˜åº¦åç§»å¥—ç”¨åœ¨ç•«ç­†ä¸Š ---
        ctx.translate(px, py - jumpOffset);

// å¦‚æœåœ¨è·³èºä¸­ï¼Œå¢åŠ ç¸®æ”¾æ•ˆæœ
        if (isJumping) {
            let s = 1 + (jumpOffset / 400); // éš¨é«˜åº¦ç¨å¾®æ”¾å¤§ 1.0~1.3 å€
            ctx.scale(s, s);
        }


        let tilt = Math.max(-0.2, Math.min(0.2, (tx - px) * 0.05));
        let tipSwing = tilt * 30;
        
        
        // é›ªæ¿
        ctx.save(); ctx.strokeStyle = '#3D3333'; ctx.lineWidth = (CHARS[selectedIdx].boardType === 'double') ? 10 : 25; ctx.lineCap = 'round';
        if (CHARS[selectedIdx].boardType === 'double') {
            const gap = 10; ctx.beginPath(); ctx.moveTo(-gap, -25); ctx.lineTo(-gap + tipSwing, 25); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(gap, -25); ctx.lineTo(gap + tipSwing, 25); ctx.stroke();
        } else { ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(tipSwing, 24); ctx.stroke(); }
        ctx.restore();

        // è¡¨æƒ…åˆ¤å®š
        if (heartTimer > 0) heartTimer--;
        if (snowHitTimer > 0) snowHitTimer--; // ğŸ’¡ æ¯å¹€å€’æ•¸
        let faceSuffix = "n";
        if (!running || invincibilityTimer > 0) faceSuffix = "d"; 
        else if (powerUpTimer > 0) faceSuffix = "e"; 
        else if (snowHitTimer > 0) faceSuffix = "s"; // ğŸ’¡ é—œéµï¼šæ’åˆ°é›ªå †æ™‚é¡¯ç¤º 's' è¡¨æƒ…
        else if (heartTimer > 0) faceSuffix = "b"; 
        else if (stormMode) faceSuffix = "s"; 
        else if (score > 0 && score % 15 <= 3) faceSuffix = "h";

        const charData = CHARS[selectedIdx], charID = charData.file;
        const bodyImg = charImages[charID], faceImg = charImages[`${charID}_${faceSuffix}`];
        const drawW = charData.size || 70, drawH = (260 / 152) * drawW;

        ctx.save();
        let breath = Math.sin(frame * 0.15) * 2; ctx.translate(0, breath); ctx.rotate(tilt * 0.5); 
        if (bodyImg && bodyImg.complete) {
// --- ğŸ’¡ ç©å®¶é ­é ‚å™´å‡ºçš„æ–‡å­—ç‰¹æ•ˆ ---
            if (heartTimer > 0) { 
                ctx.save(); 
                ctx.setTransform(1, 0, 0, 1, 0, 0); // ä½¿ç”¨çµ•å°åº§æ¨™
                ctx.translate(px, py); 
                
                // è¨­å®šæ–‡å­—æ¨£å¼ï¼šç²—é»‘é«” (åŠ é‡ç­†ç•«)
                ctx.font = `900 ${Math.floor(drawW * 0.5)}px "Inter", sans-serif`;
                ctx.textAlign = 'center';
                ctx.shadowBlur = 8;
                ctx.shadowColor = "white";

                // æ ¹æ“šç‹€æ…‹æ±ºå®šæ–‡å­—å…§å®¹èˆ‡é¡è‰²
                let floatText = "";
                if (score % 30 === 0 && score > 0 && heartTimer > 10) {
                    floatText = "+30";
                    ctx.fillStyle = "#FFD700"; // ç¾é£Ÿé‡‘é»ƒè‰²
                } else if (lives > 0) {
                    floatText = "+â¤ï¸"; // æ„›å¿ƒåªé¡¯ç¤ºåœ–ç¤ºï¼Œç°¡å–®æ˜ç­
                    ctx.fillStyle = "#ff4d4d";
                }
                
                // å‹•æ…‹é£„æµ®ï¼šéš¨è‘—æ™‚é–“å¾€ä¸Šç§»ä¸¦æ·¡å‡º
                let yOffset = -drawH - -10 - (40 - heartTimer) * 1.5;
                ctx.globalAlpha = heartTimer / 40; // æ¼¸æ¼¸æ¶ˆå¤±
                ctx.fillText(floatText, 0, yOffset); 
                ctx.restore();
            }
if (powerUpTimer > 0) { 
                // 1. è¨­å®šé–ƒçˆæ¿¾é¡ï¼šæ¯ 2 å¹€åˆ‡æ›ä¸€æ¬¡ã€Œé«˜äº®é‡‘ã€èˆ‡ã€ŒåŸè‰²ã€
                ctx.filter = (frame % 4 < 2) ? 'brightness(1.5) sepia(0.5)' : 'none'; 
                
                // 2. è¨­å®šå¤–ç™¼å…‰é™°å½±
                ctx.shadowBlur = 15; 
                ctx.shadowColor = "rgba(255, 215, 0, 0.8)"; // äº®é‡‘è‰²
            }
            ctx.drawImage(bodyImg, -drawW/2, -drawH + 5, drawW, drawH);
            ctx.shadowBlur = 0; // ç•«å®Œèº«é«”å°±æ¸…é™¤é™°å½±
            if (faceImg && faceImg.complete && faceSuffix !== 'n') {
                const faceW = drawW * (charData.faceScale || 0.6), faceH = faceImg.height * (faceW / faceImg.width);
                ctx.drawImage(faceImg, (drawW * (charData.faceX || 0)) - faceW / 2, (-drawH * (charData.faceY || 0.75)) - faceH / 2, faceW, faceH);
            }
            ctx.fillStyle = '#222222'; let bindSwing = tipSwing * 0.5;
            if (charData.boardType === 'double') {
                ctx.beginPath(); ctx.roundRect(-16 + bindSwing, -7.5, 17, 12, 4); ctx.fill();
                ctx.beginPath(); ctx.roundRect(2 + bindSwing, -7.5, 17, 12, 4); ctx.fill();
            }
            if (powerUpTimer > 0) {
                ctx.save(); 
                let glow = Math.sin(frame * 0.1) * 10 + 15;
                ctx.shadowColor = "rgba(99, 62, 12, 0.8)"; ctx.shadowBlur = glow;
                ctx.fillStyle = "#ffea4d"; ctx.font = `bold ${Math.floor(drawW * 0.3)}px Inter`; ctx.textAlign = 'center';
                ctx.fillText("ğŸŒŸ ç„¡æ•µä¹‹èº« ğŸŒŸ", 0, -drawH - 10 + Math.sin(frame * 0.05) * 5);
                
                // --- ä¿®æ­£ï¼šåªæœ‰é€™å€‹ ğŸ˜ è®Šå½©è™¹è‰² ---
                ctx.filter = `hue-rotate(${frame * 15}deg)`; 
                ctx.font = `bold ${Math.floor(drawW * 0.35)}px serif`; 
                ctx.fillText("ğŸ˜", 0, -drawH + 10); 
                ctx.restore();
            } else if (stormMode) {
                ctx.save(); ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 4; ctx.fillStyle = (frame % 20 < 10) ? '#ff4d4d' : '#ffcccc'; ctx.font = `bold ${Math.floor(drawW * 0.3)}px Inter`; ctx.textAlign = 'center'; ctx.fillText("âš ï¸ æš´é¢¨é›ªä¾†è¥² âš ï¸", (Math.random()-0.5)*3, -drawH - 30); ctx.font = `bold ${Math.floor(drawW * 0.35)}px serif`; ctx.fillText("ğŸ¥¶", 0, -drawH + 10); ctx.restore();
            }
        }
        ctx.restore(); ctx.restore();

        if (stormMode) { for(let i = 0; i < 20; i++) addStormParticle(); ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.fillStyle = 'rgba(255, 255, 255, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.restore(); }

if (comboCount >= 3) {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            if (comboScale > 1) comboScale -= 0.05;
            ctx.translate(canvas.width - 25, 110);
            ctx.scale(comboScale, comboScale);
            
            // --- ğŸ’¡ å‹•æ…‹é¡è‰²èˆ‡ç‰¹æ•ˆé‚è¼¯ ---
            let comboColor, shadowColor, glowBlur = 10;
            let label = " COMBO";

            if (comboCount >= 60) {
                // ğŸ”¥ 100é€£æ“Šï¼šç´…è‰² + è‘—ç«é–ƒçˆæ„Ÿ
                comboColor = "#ff0000";
                shadowColor = (frame % 10 < 5) ? "#ffea00" : "#ff4500"; // æ©™é»ƒé–ƒçˆç«å…‰
                glowBlur = 20 + Math.sin(frame * 0.2) * 10; // å‘¼å¸è·³å‹•çš„ç«å…‰
                label = " COMBOğŸ”¥"; // éš±è—å½©è›‹ç¨±è™Ÿ
            } else if (comboCount >= 40) {
                // ğŸŠ 50é€£æ“Šï¼šæ©˜è‰² + å¼·çƒˆç™¼å…‰
                comboColor = "#ffcb21";
                shadowColor = "#f57f17";
                glowBlur = 15;
            } else {
                // ğŸŸ¡ åˆå§‹ï¼šé»ƒè‰² (ç¶­æŒåŸæ¨£)
               comboColor = "#ff9800";
                shadowColor = "#ffeb3b";
            }

            ctx.shadowColor = shadowColor;
            ctx.shadowBlur = glowBlur;
            ctx.font = 'bold 28px "Space Mono", monospace'; // ç¨å¾®åŠ å¤§å­—é«”
            ctx.textAlign = 'right';

            // ç¹ªè£½æ¼¸å±¤æ–‡å­—
            let grad = ctx.createLinearGradient(0, -15, 0, 15);
            grad.addColorStop(0, "white"); // é ‚éƒ¨ç™¼ç™½çœ‹èµ·ä¾†æ›´æœ‰ç«‹é«”æ„Ÿ
            grad.addColorStop(1, comboColor);
            
            ctx.fillStyle = grad;
            ctx.fillText(`${comboCount}${label}`, 0, 0);
            
            // å¦‚æœè¶…é 100ï¼Œé¡å¤–åŠ ä¸€å±¤å¤–æ¡†å¢å¼·ã€Œè‘—ç«ã€è¦–è¦º
            if (comboCount >= 100) {
                ctx.strokeStyle = "white";
                ctx.lineWidth = 1;
                ctx.strokeText(`${comboCount}${label}`, 0, 0);
            }
            
            ctx.restore();
        }

        ctx.save(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.font = "24px serif"; ctx.textAlign = "left";
        let heartStr = ""; for(let i=0; i<MAX_LIVES; i++) heartStr += (i < lives) ? "â¤ï¸" : "ğŸ–¤";
        ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4; ctx.fillText(heartStr, 20, 45); ctx.restore();

        requestAnimationFrame(loop);
    }

    function addParticle(x, y, vx, vy) { if (particles.length < 150) particles.push({ x, y, vx, vy, life: 30, alpha: 1, isStorm: false }); }
    function addStormParticle() { if (particles.length < 350) particles.push({ x: Math.random() * (canvas.width + 600) - 200, y: Math.random() * -200, vx: -15 - Math.random() * 20, vy: 20 + Math.random() * 15, life: 30, alpha: 0.3 + Math.random() * 0.5, isStorm: true, size: 1 + Math.random() * 3 }); }
    function updateParticlesLogic() {
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
// --- ğŸ’¡ è™•ç†é›ªå †ç¢è£‚çš„ç‰¹æ®Šé‡åŠ›é‚è¼¯ ---
        if (p.isSnowBurst) {
            p.vy += p.gravity; // é€Ÿåº¦ä¸æ–·å‘ä¸‹å¢åŠ ï¼ˆé‡åŠ›ï¼‰
            p.y -= speed * 0.5; // è®“ç¢å¡Šè·Ÿè‘—èƒŒæ™¯å¾€å¾Œé€€ä¸€é»é»
        }


// --- åŸæœ¬çš„é‚è¼¯ ---
        else if (p.isTrack) {
            p.y -= speed ; // ç—•è·¡ç·Šè²¼åœ°é¢ç§»å‹•
            p.alpha = (p.life / 35) * 0.3;
        } else if (!p.isStorm) {
            p.y -= speed* 0.5; // æ¿€èµ·çš„é›ªèŠ±ä¹Ÿéš¨è‘—åœ°é¢å¾Œé€€
            p.alpha = (p.life / 25);
        }
        
p.x += p.vx;
        p.y += p.vy;
        p.life--;
        if (p.life <= 0) particles.splice(i, 1);
    }
}
function drawParticlesRelative() {
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®çŸ©é™£ç¢ºä¿çµ•å°åº§æ¨™ç¹ªè£½

    particles.forEach(p => {
        ctx.save();
        ctx.globalAlpha = p.alpha;

        if (p.isTrack) {
            // --- ç¹ªè£½ï¼šåœ°é¢æ»‘ç—• ---
            ctx.fillStyle = 'rgba(100, 130, 170, 0.2)';
            ctx.beginPath();
            ctx.ellipse(p.x, p.y, p.width / 2, 3, 0, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // --- ç¹ªè£½ï¼šæ¿€èµ·çš„é›ªèŠ±èˆ‡æš´é¢¨é›ª ---
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'white';
            if (p.isStorm) {
                // æš´é¢¨é›ªç²’å­ç¶­æŒçµ•å°ä½ç½®
                ctx.lineWidth = p.size;
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(p.x + p.vx * 0.8, p.y + p.vy * 0.8);
                ctx.stroke();
} else {
    // æ»‘è¡Œé›ªèŠ±ç²’å­æˆ–ç¢è£‚ç¢å¡Š
    ctx.beginPath();
    // ğŸ’¡ ä½¿ç”¨ p.size æˆ–é è¨­å€¼ 2
    let radius = p.isSnowBurst ? (p.size * 0.6) : 1.5;
    ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
    ctx.fill();
}
        }
        ctx.restore();
    });
    ctx.restore();
}

function togglePause() {
    if (!running) return; // å¦‚æœå·²ç¶“çµæŸäº†å°±ä¸å‹•ä½œ
    
    isPaused = !isPaused;
    const pauseUI = document.getElementById('uiPause');
    const pauseBtn = document.getElementById('pauseBtn');

    if (isPaused) {
        pauseUI.classList.remove('hidden');
        pauseBtn.classList.add('hidden'); // æš«åœæ™‚éš±è—æŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
    } else {
        pauseUI.classList.add('hidden');
        pauseBtn.classList.remove('hidden');
        requestAnimationFrame(loop); // æ¢å¾©å¾Œé‡æ–°å•Ÿå‹•å¾ªç’°
    }
}


// æ–°å¢ï¼šåˆ‡æ›åˆ°æ’è¡Œæ¦œé é¢çš„å‡½æ•¸
function showLeaderboardPage() {
    document.getElementById('gameOverResult').classList.add('hidden');
    document.getElementById('gameOverLeaderboard').classList.remove('hidden');
}



async function triggerGameOver() {
    running = false;
    document.getElementById('pauseBtn').classList.add('hidden');
    
    // ğŸ’¡ é—œéµï¼šæ¯æ¬¡çµæŸæ™‚ï¼Œé‡ç½®å›ç¬¬ä¸€é é¡¯ç¤º
    document.getElementById('gameOverResult').classList.remove('hidden');
    document.getElementById('gameOverLeaderboard').classList.add('hidden');
    let medal = "â„ï¸", title = "ã€å†æ¥å†å²ã€‘", colorClass = "text-gray-400";
    let nextMsg = "";

const tiers = [
        { score: 2500, medal: "ğŸ‘‘", title: "ã€å†°åŸè‡³å°Šã€‘", color: "text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white font-black italic" },
        { score: 1700, medal: "ğŸ’", title: "ã€å“ˆçˆ¾æ¿±é‘½çŸ³ã€‘", color: "text-cyan-300 drop-shadow-[0_0_10px_rgba(103,232,249,0.8)]" },
        { score: 1300, medal: "ğŸ¥‡", title: "ã€å“ˆçˆ¾æ¿±å‚³èªªã€‘", color: "text-yellow-400" },
        { score: 900, medal: "ğŸ¥ˆ", title: "ã€å°ˆæ¥­æ»‘é›ªæ‰‹ã€‘", color: "text-gray-200" },
        { score: 600, medal: "ğŸ¥‰", title: "ã€äºå¸ƒåŠ›å‹‡å£«ã€‘", color: "text-orange-400" },
        { score: 400, medal: "ğŸ¥½", title: "ã€æ»‘é›ªé“æŒ‘æˆ°ä¸­ã€‘", color: "text-yellow-200" },
        { score: 200, medal: "ğŸ¬", title: "ã€æ»‘é›ªåˆé«”é©—ã€‘", color: "text-green-300" }
    ];

let currentTierIdx = -1;
    for (let i = 0; i < tiers.length; i++) {
        if (score >= tiers[i].score) {
            currentTierIdx = i;
            medal = tiers[i].medal;
            title = tiers[i].title;
            colorClass = tiers[i].color;
            break;
        }
    }

if (currentTierIdx === 0) {
        nextMsg = "ğŸ‰ å·²é”åˆ°æœ€é«˜æ¦®è­½ï¼";
    } else {
        let nextTier = tiers[currentTierIdx === -1 ? tiers.length - 1 : currentTierIdx - 1];
        let diff = nextTier.score - score;
        nextMsg = `é›¢ä¸‹ä¸€éšã€${nextTier.title}ã€‘é‚„å·® <span class="text-yellow-300 font-bold">${diff}</span> åˆ†`;
    }


// æ’è¡Œæ¦œé è®€å–èˆ‡ä¸Šå‚³é‚è¼¯
    try {
        const savedName = localStorage.getItem('skiPlayerName');
        const selectedCharName = CHARS[selectedIdx].name;
        const finalPlayerName = savedName || selectedCharName || "åŒ¿åç©å®¶";
        window.playerName = finalPlayerName;

        // éœé»˜ä¸Šå‚³ä¸¦å–å¾— Key
        currentScoreKey = await uploadScore(finalPlayerName, score);
        
        // é å…ˆæŠ“å–æ¦œå–®ï¼ˆé€™æ¨£é»æ“Šåˆ‡æ›æ™‚å°±ä¸ç”¨ç­‰ï¼‰
        const rawList = await fetchLeaderboard();
        const { list, myRank } = injectMyScore(rawList, finalPlayerName, score);
        renderLeaderboard(list, myRank);

    } catch (err) {
        console.error("Leaderboard Error:", err);
    }





// --- ä»¥ä¸‹ç‚ºåŸæœ¬çš„ UI æ¸²æŸ“é‚è¼¯ï¼Œä¿æŒä¸è®Š ---
    document.getElementById('uiOver').classList.remove('hidden');
    document.getElementById('medalIcon').textContent = medal;
    document.getElementById('medalTitle').textContent = title;
    document.getElementById('medalTitle').className = `text-3xl font-bold mb-2 ${colorClass} drop-shadow-md`;
    
// å–å¾—å¾—åˆ†å®¹å™¨
const scoreContainer = document.getElementById('finalScore').parentElement;

// è™•ç†ã€Œé›¢ä¸‹ä¸€éšé‚„å·®å¹¾åˆ†ã€çš„é¡¯ç¤º
let nextTierEl = document.getElementById('nextTierTier');
if (!nextTierEl) {
    nextTierEl = document.createElement('p');
    nextTierEl.id = 'nextTierTier';
    nextTierEl.className = 'text-sm text-blue-200 mt-2 opacity-80 italic';
    scoreContainer.parentNode.insertBefore(nextTierEl, scoreContainer.nextSibling);
}
nextTierEl.innerHTML = nextMsg;

// è™•ç†åˆ†æ•¸èˆ‡ç ´ç´€éŒ„é‚è¼¯
let highScore = localStorage.getItem('skiHighScore') || 0;

// å®šç¾©æ©˜ç´…è‰²è·³å‹•çš„ HTML æ¨¡æ¿
const scoreHTML = `
    <div class="score-highlight-group">
        <span class="score-label">æœ€çµ‚å¾—åˆ†:</span>
        <span class="score-number">${score}</span>
    </div>
`;

if (score > highScore) {
    localStorage.setItem('skiHighScore', score);
    scoreContainer.innerHTML = scoreHTML + `<div class="text-yellow-300 text-sm mt-1">New Record!</div>`;
} else {
    scoreContainer.innerHTML = scoreHTML + `<div class="text-gray-400 text-sm mt-1">æ­·å²æœ€é«˜: ${highScore}</div>`;
}


}


    window.onresize = resize; resize(); initCharSelect();

const LEADERBOARD_LIMIT = 20;



function renderLeaderboard(list, myRank) {
    const listContainer = document.getElementById('leaderboardList');
    const stickyContainer = document.getElementById('personalRankSticky');
    if (!listContainer || !stickyContainer) return;

    // 1. æ¸²æŸ“æ¸…å–® (ä¿æŒä½ åŸæœ¬çš„ä»£ç¢¼)
    listContainer.innerHTML = list.map((item, index) => {
        const isMe = item.isMe ? "bg-blue-500/40 border border-blue-400" : "border-b border-white/5";
        const rankColor = index === 0 ? "text-yellow-400" : (index === 1 ? "text-gray-300" : (index === 2 ? "text-orange-400" : "text-white"));
        const nameDisplay = item.name === "è·¯äºº" ? `<span class="opacity-40 text-xs italic">è·¯äºº</span>` : item.name;
        return `
            <div class="flex justify-between items-center py-2 px-3 ${isMe} rounded-lg mb-1">
                <span class="${rankColor} font-bold text-sm">#${index + 1} ${nameDisplay}</span>
                <span class="font-mono text-sm ${item.name === "è·¯äºº" ? "opacity-30" : ""}">${item.score}</span>
            </div>
        `;
    }).join('');

    // 2. è™•ç†ç½®åº•å›ºå®šé¡¯ç¤º
    const myName = window.playerName || "åŒ¿åç©å®¶";
    stickyContainer.classList.remove('hidden');
    
    // æª¢æŸ¥ localStorage ç¢ºä¿å¦‚æœé€™å ´å·²ç¶“æ”¹éåäº†ï¼Œæ¸²æŸ“å‡ºä¾†çš„æŒ‰éˆ•ç›´æ¥å°±æ˜¯ç¦ç”¨çš„
    // ä½†å› ç‚ºä¸€å ´éŠæˆ²åªèƒ½æ”¹ä¸€æ¬¡ï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹è‡¨æ™‚è®Šæ•¸æˆ–ç›´æ¥æª¢æŸ¥æŒ‰éˆ•æ–‡å­—
    stickyContainer.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="text-white font-bold text-sm">#${myRank} ${myName}</span>
            <button onclick="renameFlow()" class="btn-rename">æ”¹å</button>
        </div>
        <span class="font-mono text-white font-bold">${score}</span>
    `;
}

// ç¨ç«‹çš„å–åæµç¨‹
async function renameFlow() {
    const btn = document.querySelector('.btn-rename');
    if (btn && btn.disabled) return;

    const newName = prompt("è«‹è¼¸å…¥ä½ çš„æ»‘é›ªå¤§åï¼š", localStorage.getItem('skiPlayerName') || "");
    
    if (newName && newName.trim() !== "") {
        if (btn) {
            btn.innerText = "å‚³é€ä¸­...";
            btn.disabled = true; 
            btn.style.opacity = "0.7";
        }

        window.playerName = newName;
        localStorage.setItem('skiPlayerName', newName);
        
        try {
            // ğŸ’¡ é—œéµä¿®æ­£ï¼šå‚³å…¥ currentScoreKeyï¼ŒFirebase å°±æœƒæ›´æ–°èˆŠè³‡æ–™è€Œéæ–°å¢
            await uploadScore(newName, score, currentScoreKey);
            
            const rawList = await fetchLeaderboard();
            const { list, myRank } = injectMyScore(rawList, newName, score);
            renderLeaderboard(list, myRank);

            // é–å®šæŒ‰éˆ•ç‹€æ…‹
            const successBtn = document.querySelector('.btn-rename');
            if (successBtn) {
                successBtn.innerText = "âœ… æ”¹åæˆåŠŸ";
                successBtn.style.background = "#22c55e"; 
                successBtn.style.color = "white";
                successBtn.style.opacity = "1";
                successBtn.disabled = true; 
                successBtn.onclick = null; 
            }
        } catch (e) {
            console.error(e);
            if (btn) {
                btn.innerText = "é‡è©¦";
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }
    }
}






function injectMyScore(list, myName, myScore) {
    // éæ­·æ¸…å–®ï¼Œåªæœ‰åå­—ã€åˆ†æ•¸ä¸” Key(ts) éƒ½å»åˆæ‰æ¨™è¨˜ç‚º isMe
    const displayList = list.map(item => ({
        ...item,
        isMe: item.name === myName && item.score === myScore
    }));

    // å–å¾—ç•¶å‰ç©å®¶åœ¨æ¸…å–®ä¸­çš„ç´¢å¼•
    const myRank = list.findIndex(s => s.name === myName && s.score === myScore) + 1;
    return { list: displayList, myRank: myRank || 999 };
}





function fetchLeaderboard() {
    return database
        .ref('leaderboard')
        .once('value')
        .then(snapshot => {
            let list = [];
            snapshot.forEach(snap => {
                const data = snap.val();
                if (data && data.score !== undefined) {
                    list.push(data);
                }
            });

            // 1. å…ˆæ’åºçœŸå¯¦ç©å®¶
            list.sort((a, b) => b.score - a.score);

            // 2. å¦‚æœäººæ•¸ä¸è¶³ï¼Œç”¨ NPC è£œé½Šåˆ° LEADERBOARD_LIMIT
            if (list.length < LEADERBOARD_LIMIT) {
                const npcCount = LEADERBOARD_LIMIT - list.length;
                for (let i = 0; i < npcCount; i++) {
                    list.push({
                        name: "è·¯äºº",
                        // è®“è·¯äººçš„åˆ†æ•¸ç¨å¾®çœŸå¯¦ä¸€é»ï¼Œä»‹æ–¼ 50 åˆ° 300 ä¹‹é–“
                        score: Math.floor(Math.random() * 250) + 50,
                        ts: Date.now(),
                        isNPC: true
                    });
                }
            }

            // 3. è£œå®Œ NPC å¾Œé‡æ–°æ’åºä¸€æ¬¡
            return list.sort((a, b) => b.score - a.score).slice(0, LEADERBOARD_LIMIT);
        });
}


// ä¿®æ”¹å¾Œçš„ä¸Šå‚³å‡½æ•¸
function uploadScore(name, score, existingKey = null) {
    if (existingKey) {
        // å¦‚æœæœ‰èˆŠçš„ Keyï¼Œå°±æ›´æ–°è©²ç­†è³‡æ–™
        return database.ref('leaderboard/' + existingKey).set({
            name,
            score,
            ts: Date.now()
        }).then(() => existingKey); // è¿”å›åŒä¸€å€‹ Key
    } else {
        // å¦‚æœæ²’æœ‰ Keyï¼Œå°±ç”¢ç”Ÿæ–°çš„ä¸€ç­†
        const newRef = database.ref('leaderboard').push();
        return newRef.set({
            name,
            score,
            ts: Date.now()
        }).then(() => newRef.key); // è¿”å›æ–°ç”¢ç”Ÿçš„ Key
    }
}


</script>
</body>
</html>